<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>ImageScraper by Tate</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="icon" href="/icons/favicon.ico" type="image/x-icon" sizes="16x16 32x32">
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png">
    <link rel="manifest" href="/icons/site.webmanifest">
    <style>
      html, body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        text-align: center;
        background-color: #e8e8e8;
        color: #000000;
        min-height: 100vh;
      }
      body {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }
      .container {
        flex: 1 auto;
      }
      footer {
        flex-shrink: 0;
        font-size: 12pt;
        text-align: center;
        padding: 10px;
        color: #333333;
      }
      .dark-theme footer {
        color: #ffffff;
      }
      h1 {
        margin-top: 0;
      }
      .dark-theme {
        background: #333333 var(--background-image, none) no-repeat center center fixed;
        background-size: cover;
        color: #ffffff;
      }
      #container {
        font-size: 32px;
        margin: 20px 0;
      }
      .img-container {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
      }
      .inner-card {
        display: inline-block;
        margin: 10px;
        padding: 10px;
        background-color: #abebff;
        text-align: center;
      }
      .dark-theme .inner-card {
        background-color: #cbccce;
      }
      .inner-card h3 {
        color: #333333;
      }
      .dark-theme .inner-card h3 {
        color: #ffffff;
      }
      .inner-card h3 a {
        color: inherit;
        text-decoration: none;
      }
      .inner-card h3 a:hover {
        text-decoration: underline;
      }
      #error-message {
        color: red;
        font-size: 14pt;
        font-weight: bold;
        margin-top: 10px;
        display: none;
      }
      .dark-theme #error-message {
        color: #ff9999;
      }
      .btn {
        font-size: 14pt;
        margin: 0 5px;
        padding: 4px 15px;
        cursor: pointer;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
      }
      .btn:hover {
        background-color: #0056b3;
      }
      .dark-theme .btn {
        background-color: #b32318;
      }
      .dark-theme .btn:hover {
        background-color: #8e1c13;
      }
      .btn:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
        color: #666666;
      }
      .dark-theme .btn:disabled {
        color: #999999;
      }
      #cancel-btn {
        background-color: #dc3545;
      }
      .dark-theme #cancel-btn {
        background-color: #b32318;
      }
      #cancel-btn:hover {
        background-color: #c82333;
      }
      .dark-theme #cancel-btn:hover {
        background-color: #8e1c13;
      }
      #theme-btn, #download-btn, #search-btn, #batch-save-btn {
        position: absolute;
        top: 10px;
        background-color: #333333;
        font-size: 12pt;
        padding: 8px;
        display: block;
      }
      #theme-btn { right: 10px; }
      #download-btn { right: 50px; }
      #search-btn { right: 90px; }
      #batch-save-btn { right: 130px; }
      #theme-btn:hover, #download-btn:hover, #search-btn:hover, #batch-save-btn:hover {
        background-color: #555555;
      }
      .dark-theme #theme-btn, .dark-theme #download-btn, .dark-theme #search-btn, .dark-theme #batch-save-btn {
        background-color: #b32318;
      }
      .dark-theme #theme-btn:hover, .dark-theme #download-btn:hover, .dark-theme #search-btn:hover, .dark-theme #batch-save-btn:hover {
        background-color: #8e1c13;
      }
      img {
        max-width: 100%;
        height: auto;
        display: block;
      }
      .default-image {
        max-width: 400px;
      }
      .image-error {
        color: red;
        font-size: 12pt;
        margin: 10px 0;
      }
      .dark-theme .image-error {
        color: #ff9999;
      }
      #loading {
        font-size: 14pt;
        margin-top: 10px;
        display: none;
      }
      .dark-theme #loading {
        color: #ffffff;
      }
      #sku-input {
        font-size: 14pt;
        margin: 0 5px;
        padding: 5px;
        width: 100px;
        text-align: center;
      }
      .dark-theme #sku-input {
        color: #ffffff;
        background-color: #333333;
        border: 1px solid #ffffff;
      }
      #checked-skus, #valid-skus-range {
        font-size: 12pt;
        margin-top: 10px;
        max-width: 600px;
        margin-left: auto;
        margin-right: auto;
        word-wrap: break-word;
      }
      .dark-theme #checked-skus, .dark-theme #valid-skus-range {
        color: #ffffff;
      }
      .dark-theme h1, .dark-theme h2 {
        color: #ffffff;
      }
      #cancel-btn {
        display: none;
      }
      /* Batch Save Modal Styles */
      .batch-modal {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: #ffffff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        width: 300px;
        text-align: left;
      }
      .dark-theme .batch-modal {
        background-color: #333333;
        color: #ffffff;
      }
      .batch-modal h3 {
        margin-top: 0;
        color: #000000;
      }
      .dark-theme .batch-modal h3 {
        color: #ffffff;
      }
      #batch-sku-input {
        width: 100%;
        padding: 5px;
        margin-bottom: 10px;
        font-size: 12pt;
        color: #000000;
      }
      .dark-theme #batch-sku-input {
        color: #ffffff;
        background-color: #444444;
        border: 1px solid #ffffff;
      }
      #batch-sku-list {
        max-height: 150px;
        overflow-y: auto;
        margin-bottom: 10px;
      }
      .batch-sku-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 5px;
        border-bottom: 1px solid #cccccc;
      }
      .dark-theme .batch-sku-item {
        border-bottom: 1px solid #666666;
      }
      .batch-sku-item span {
        font-size: 12pt;
      }
      .batch-sku-item button {
        background-color: #dc3545;
        color: white;
        border: none;
        padding: 2px 8px;
        cursor: pointer;
        border-radius: 3px;
        font-size: 10pt;
      }
      .batch-sku-item button:hover {
        background-color: #c82333;
      }
      .dark-theme .batch-sku-item button {
        background-color: #b32318;
      }
      .dark-theme .batch-sku-item button:hover {
        background-color: #8e1c13;
      }
      .batch-modal .btn {
        font-size: 12pt;
        padding: 5px 10px;
        margin-right: 5px;
      }
      #batch-error {
        color: red;
        font-size: 10pt;
        margin-bottom: 10px;
        display: none;
      }
      .dark-theme #batch-error {
        color: #ff9999;
      }
      .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 999;
      }
      #theme-label {
        position: absolute;
        top: 40px;
        right: 10px;
        font-size: 10pt;
        color: #333333;
        background-color: rgba(255, 255, 255, 0.8);
        padding: 2px 5px;
        border-radius: 3px;
      }
      .dark-theme #theme-label {
        color: #ffffff;
        background-color: rgba(0, 0, 0, 0.8);
      }
      #product-title {
      font-size: 14pt;
      margin-top: 10px;
      display: none;
      }
     .dark-theme #product-title {
     color: #ffffff;
     }
     #product-title p {
     margin: 5px 0;
     }
    </style>
  </head>
  <body>
    <main>
      <!-- Batch Save Button -->
      <button id="batch-save-btn" class="btn" aria-label="Batch save SKUs"><i class="fas fa-save"></i></button>
      <button id="search-btn" class="btn" aria-label="Search IFSTA for SKU"><i class="fas fa-globe"></i></button>
      <button id="download-btn" class="btn" aria-label="Download PNG images as ZIP"><i class="fas fa-cloud-arrow-down"></i></button>
      <button id="theme-btn" class="btn" aria-label="Switch to next background"><i class="fas fa-paint-brush"></i></button>
      <span id="theme-label"></span>
      <!-- Batch Save Modal -->
      <div class="modal-overlay" id="batch-modal-overlay"></div>
      <div class="batch-modal" id="batch-modal">
        <h3>Batch Save SKUs</h3>
        <input type="text" id="batch-sku-input" placeholder="Enter 5-digit SKU" aria-label="Enter SKU for batch download">
        <div id="batch-error" aria-live="polite"></div>
        <button id="batch-add-btn" class="btn" aria-label="Add SKU to batch">Add SKU</button>
        <div id="batch-sku-list" aria-label="List of SKUs for batch download"></div>
        <button id="batch-download-btn" class="btn" aria-label="Download batch SKUs as ZIP" disabled>Batch Download</button>
        <button id="batch-cancel-btn" class="btn" aria-label="Cancel batch save">Cancel</button>
      </div>
      <h1>Welcome to ImageScraper!</h1>
      <h2>By Tate</h2>
      <div id="formID">
        <button id="sizes-btn" class="btn" aria-label="Show additional image sizes" aria-expanded="false">Sizes</button>
        <button id="prev-exterior-btn" class="btn" aria-label="Previous Untested Product">≪</button>
        <button id="prev-interior-btn" class="btn" aria-label="Previous Valid Product" disabled>←</button>
        <input type="text" id="sku-input" aria-required="true" value="00000">
        <button id="next-interior-btn" class="btn" aria-label="Next Valid Product" disabled>→</button>
        <button id="next-exterior-btn" class="btn" aria-label="Next Untested Product">≫</button>
        <button id="submit-btn" class="btn" aria-label="Submit SKU">Go</button>
        <button id="clear-btn" class="btn" aria-label="Clear input and images">Clear</button>
        <button id="cancel-btn" class="btn" aria-label="Cancel ongoing scan">Cancel</button>
      </div>
      <div id="error-message" aria-live="polite"></div>
      <div id="product-title" aria-live="polite"></div>
      <div id="loading">Loading...</div>
      <div id="tableID"></div>
      <div id="checked-skus">Checked SKUs (no images): None</div>
      <div id="valid-skus-range">Known SKUs with images: None</div>
    </main>
    <footer id="footer" aria-label="IFSTA Copyright 2025">IFSTA © 2025 https://github.com/aaronfpp/image-scraper</footer>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script type="text/javascript">
      const section = {
        baseURL: "https://images.ifsta.org/products/",
        sizes: ["default", "thumb", "69", "100", "130", "150", "180", "200", "200x200", "420"],
        fileTypes: [".png", ".webp"],
        inputLabel: "SKU",
        validationRegex: /^[0-9]{5}$/,
        fetchTimeout: 10000
      };
      
      const backgrounds = [
        { name: "Default", url: "" },
        { name: "Alternative 1", url: "/images/background_alt1.jpg" },
        { name: "Alternative 2", url: "/images/background_alt2.jpg" },
        { name: "Alternative 3", url: "/images/background_e8.jpg" }
      ];
      
      const themeBtn = document.getElementById("theme-btn");
      const downloadBtn = document.getElementById("download-btn");
      const searchBtn = document.getElementById("search-btn");
      const batchSaveBtn = document.getElementById("batch-save-btn");
      const batchModal = document.getElementById("batch-modal");
      const batchModalOverlay = document.getElementById("batch-modal-overlay");
      const batchSKUInput = document.getElementById("batch-sku-input");
      const batchAddBtn = document.getElementById("batch-add-btn");
      const batchDownloadBtn = document.getElementById("batch-download-btn");
      const batchCancelBtn = document.getElementById("batch-cancel-btn");
      const batchSKUList = document.getElementById("batch-sku-list");
      const batchError = document.getElementById("batch-error");
      const sizesBtn = document.getElementById("sizes-btn");
      const prevExteriorBtn = document.getElementById("prev-exterior-btn");
      const nextExteriorBtn = document.getElementById("next-exterior-btn");
      const prevInteriorBtn = document.getElementById("prev-interior-btn");
      const nextInteriorBtn = document.getElementById("next-interior-btn");
      const skuInput = document.getElementById("sku-input");
      const submitBtn = document.getElementById("submit-btn");
      const clearBtn = document.getElementById("clear-btn");
      const cancelBtn = document.getElementById("cancel-btn");
      const errorMessage = document.getElementById("error-message");
      const loading = document.getElementById("loading");
      const tableContainer = document.getElementById("tableID");
      const checkedSKUsDisplay = document.getElementById("checked-skus");
      const validSKUsRangeDisplay = document.getElementById("valid-skus-range");
      const themeLabel = document.getElementById("theme-label");
      
      let testedSKUs = JSON.parse(localStorage.getItem("testedSKUs")) || [];
      let validSKUs = JSON.parse(localStorage.getItem("validSKUs")) || [];
      let batchSKUs = [];
      let currentSKU = localStorage.getItem("currentSKU") && section.validationRegex.test(localStorage.getItem("currentSKU")) ? localStorage.getItem("currentSKU") : "00000";
      let isScanning = false;
      let abortController = null;
      let lastSKU = currentSKU;
      let scanCount = 0;
      const maxScanAttempts = 100;
      let showAllSizes = false;
      let currentBackgroundIndex = parseInt(localStorage.getItem("currentBackgroundIndex")) || 0;
      
      skuInput.value = currentSKU;
      updateCheckedSKUsDisplay();
      updateValidSKUsRange();
      updateInteriorButtonState();
      updateTheme();
      
      themeBtn.addEventListener("click", toggleTheme);
      downloadBtn.addEventListener("click", downloadImagesAsZip);
      searchBtn.addEventListener("click", searchIFSTA);
      batchSaveBtn.addEventListener("click", toggleBatchModal);
      batchAddBtn.addEventListener("click", addBatchSKU);
      batchDownloadBtn.addEventListener("click", downloadBatchImagesAsZip);
      batchCancelBtn.addEventListener("click", closeBatchModal);
      batchModalOverlay.addEventListener("click", closeBatchModal);
      sizesBtn.addEventListener("click", toggleSizes);
      prevExteriorBtn.addEventListener("click", () => navigateSKU(-1));
      nextExteriorBtn.addEventListener("click", () => navigateSKU(1));
      prevInteriorBtn.addEventListener("click", () => navigateValidSKU(-1));
      nextInteriorBtn.addEventListener("click", () => navigateValidSKU(1));
      submitBtn.addEventListener("click", submitSKU);
      skuInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") submitSKU();
      });
      clearBtn.addEventListener("click", clearForm);
      cancelBtn.addEventListener("click", cancelScan);
      
      displayImages(currentSKU);
      
      function toggleTheme() {
        currentBackgroundIndex = (currentBackgroundIndex + 1) % backgrounds.length;
        localStorage.setItem("currentBackgroundIndex", currentBackgroundIndex);
        updateTheme();
      }
      
      function updateTheme() {
        const isDarkTheme = currentBackgroundIndex !== 0;
        document.body.classList.toggle("dark-theme", isDarkTheme);
        const bgUrl = backgrounds[currentBackgroundIndex].url ? `url('${backgrounds[currentBackgroundIndex].url}')` : 'none';
        document.documentElement.style.setProperty('--background-image', bgUrl);
        themeBtn.setAttribute("aria-label", `Switch to ${backgrounds[(currentBackgroundIndex + 1) % backgrounds.length].name} background`);
        themeLabel.textContent = `Theme: ${backgrounds[currentBackgroundIndex].name}`;
      }
      
      function toggleBatchModal() {
        batchModal.style.display = "block";
        batchModalOverlay.style.display = "block";
        batchSKUInput.focus();
        updateBatchSKUList();
        batchSaveBtn.disabled = true;
      }
      
      function closeBatchModal() {
        batchModal.style.display = "none";
        batchModalOverlay.style.display = "none";
        batchSKUInput.value = "";
        batchError.style.display = "none";
        batchError.textContent = "";
        batchSKUs = [];
        updateBatchSKUList();
        batchSaveBtn.disabled = false;
      }
      
      function addBatchSKU() {
        const sku = batchSKUInput.value.trim();
        batchError.style.display = "none";
        batchError.textContent = "";
        
        if (!sku) {
          batchError.textContent = "Error: SKU cannot be empty.";
          batchError.style.display = "block";
          return;
        }
        
        if (!section.validationRegex.test(sku)) {
          batchError.textContent = "Error: SKU must be a 5-digit number (e.g., 12345).";
          batchError.style.display = "block";
          return;
        }
        
        if (batchSKUs.includes(sku)) {
          batchError.textContent = "Error: SKU already added.";
          batchError.style.display = "block";
          return;
        }
        
        batchSKUs.push(sku);
        batchSKUInput.value = "";
        updateBatchSKUList();
        batchError.textContent = "SKU added successfully.";
        batchError.style.display = "block";
        setTimeout(() => batchError.style.display = "none", 3000);
      }
      
      function updateBatchSKUList() {
        batchSKUList.innerHTML = "";
        batchDownloadBtn.disabled = batchSKUs.length === 0;
        if (batchSKUs.length === 0) {
          const emptyItem = document.createElement("div");
          emptyItem.textContent = "No SKUs added.";
          emptyItem.style.fontSize = "12pt";
          emptyItem.style.padding = "5px";
          batchSKUList.appendChild(emptyItem);
          return;
        }
        batchSKUs.forEach((sku, index) => {
          const item = document.createElement("div");
          item.className = "batch-sku-item";
          const skuText = document.createElement("span");
          skuText.textContent = sku;
          const removeBtn = document.createElement("button");
          removeBtn.textContent = "Remove";
          removeBtn.addEventListener("click", () => {
            batchSKUs.splice(index, 1);
            updateBatchSKUList();
          });
          item.appendChild(skuText);
          item.appendChild(removeBtn);
          batchSKUList.appendChild(item);
        });
      }
      
      async function downloadBatchImagesAsZip() {
        console.log(`Starting batch download for SKUs: ${batchSKUs.join(", ")}`);
        if (batchSKUs.length === 0) {
          console.warn("No SKUs in batch list");
          batchError.textContent = "Error: No SKUs added for batch download.";
          batchError.style.display = "block";
          return;
        }
        
        batchDownloadBtn.disabled = true;
        batchAddBtn.disabled = true;
        errorMessage.style.display = "none";
        errorMessage.textContent = "";
        batchError.style.display = "none";
        loading.style.display = "block";
        
        const zip = new JSZip();
        let hasImages = false;
        const missingImages = [];
        const missingSKUs = [];
        const downloadedSKUs = [...batchSKUs];
        
        for (const sku of batchSKUs) {
          console.log(`Fetching images for SKU: ${sku}`);
          let skuHasImages = false;
          for (const size of section.sizes) {
            const type = ".png";
            const url = `/api/fetch-image?sku=${sku}&size=${size}&type=${type}`;
            const fileName = `${sku}_${size}${type}`;
            
            try {
              console.log(`Fetching URL: ${url}`);
              const response = await fetch(url, { method: "GET" });
              console.log(`[${sku}] ${size}${type}: Status ${response.status}`);
              
              if (response.ok) {
                const data = await response.json();
                if (data.isBase64Encoded) {
                  console.log(`[${sku}] ${size}${type}: Valid base64 image found`);
                  const binaryString = atob(data.body);
                  const len = binaryString.length;
                  const bytes = new Uint8Array(len);
                  for (let i = 0; i < len; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                  }
                  zip.file(fileName, bytes);
                  hasImages = true;
                  skuHasImages = true;
                } else {
                  console.warn(`[${sku}] ${size}${type}: Response not base64 encoded`);
                  missingImages.push(`${sku}_${size}${type}`);
                }
              } else {
                console.warn(`[${sku}] ${size}${type}: Failed with status ${response.status}`);
                missingImages.push(`${sku}_${size}${type}`);
              }
            } catch (error) {
              console.error(`[${sku}] ${size}${type}: Error fetching: ${error.message}`);
              missingImages.push(`${sku}_${size}${type}`);
            }
            await new Promise(resolve => setTimeout(resolve, 100)); // Rate limiting
          }
          if (!skuHasImages) {
            missingSKUs.push(sku);
          }
        }
        
        console.log(`Batch fetch complete. Has images: ${hasImages}, Missing images: ${missingImages.join(", ")}`);
        loading.style.display = "none";
        batchDownloadBtn.disabled = false;
        batchAddBtn.disabled = false;
        
        if (!hasImages) {
          console.error(`No images found for SKUs: ${downloadedSKUs.join(", ")}`);
          errorMessage.textContent = `Error: No PNG images found for SKUs: ${downloadedSKUs.join(", ")}. Missing: ${missingImages.join(", ")}`;
          errorMessage.style.display = "block";
          closeBatchModal();
          return;
        }
        
        try {
          console.log("Generating ZIP file");
          closeBatchModal(); // Clear after fetching
          const content = await zip.generateAsync({ type: "blob" });
          saveAs(content, `batch_skus_${Date.now()}.zip`);
          console.log(`ZIP generated successfully for SKUs: ${downloadedSKUs.join(", ")}`);
          errorMessage.textContent = `Success: Batch download complete for SKUs: ${downloadedSKUs.join(", ")}.`;
          errorMessage.style.display = "block";
          setTimeout(() => errorMessage.style.display = "none", 3000);
          if (missingImages.length > 0) {
            errorMessage.textContent += ` Warning: Some images missing: ${missingImages.join(", ")}`;
            errorMessage.style.display = "block";
          }
        } catch (error) {
          console.error(`Error generating ZIP: ${error.message}`);
          errorMessage.textContent = `Error: Failed to generate batch ZIP file: ${error.message}`;
          errorMessage.style.display = "block";
          closeBatchModal();
        }
      }
      
      function toggleSizes() {
        showAllSizes = !showAllSizes;
        sizesBtn.textContent = showAllSizes ? "Hide Sizes" : "Sizes";
        sizesBtn.setAttribute("aria-expanded", showAllSizes);
        sizesBtn.setAttribute("aria-label", showAllSizes ? "Hide additional image sizes" : "Show additional image sizes");
        displayImages(currentSKU);
      }
      
      function searchIFSTA() {
        const searchUrl = `https://www.ifsta.org/shop/product/${currentSKU}`;
        window.open(searchUrl, '_blank');
      }
      
      async function downloadImagesAsZip() {
        downloadBtn.disabled = true;
        errorMessage.style.display = "none";
        errorMessage.textContent = "";
        loading.style.display = "block";
        
        const zip = new JSZip();
        let hasImages = false;
        const missingImages = [];
        
        for (const size of section.sizes) {
          const type = ".png";
          const url = `/api/fetch-image?sku=${currentSKU}&size=${size}&type=${type}`;
          const fileName = `${currentSKU}_${size}${type}`;
          
          try {
            const response = await fetch(url, { method: "GET" });
            console.log(`Fetching ${url}: Status ${response.status}`);
            if (response.ok) {
              const data = await response.json();
              if (data.isBase64Encoded) {
                const binaryString = atob(data.body);
                const len = binaryString.length;
                const bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++) {
                  bytes[i] = binaryString.charCodeAt(i);
                }
                const blob = new Blob([bytes], { type: data.contentType });
                zip.file(fileName, blob);
                hasImages = true;
              } else {
                throw new Error('Response is not base64 encoded');
              }
            } else {
              missingImages.push(`${size}${type}`);
              console.log(`Failed to fetch ${url}: Status ${response.status}`);
            }
          } catch (error) {
            missingImages.push(`${size}${type}`);
            console.error(`Error fetching ${url}: ${error.message}`);
          }
        }
        
        if (!hasImages) {
          loading.style.display = "none";
          errorMessage.textContent = `Error: No PNG images found for SKU ${currentSKU}. Missing: ${missingImages.join(", ")}`;
          errorMessage.style.display = "block";
          downloadBtn.disabled = false;
          return;
        }
        
        try {
          const content = await zip.generateAsync({ type: "blob" });
          saveAs(content, `images_${currentSKU}.zip`);
          if (missingImages.length > 0) {
            errorMessage.textContent = `Warning: Some PNG images missing for SKU ${currentSKU}: ${missingImages.join(", ")}`;
            errorMessage.style.display = "block";
          }
        } catch (error) {
          console.error(`Error generating ZIP: ${error.message}`);
          errorMessage.textContent = "Error: Failed to generate ZIP file.";
          errorMessage.style.display = "block";
        }
        
        loading.style.display = "none";
        downloadBtn.disabled = false;
      }
      
      async function submitSKU() {
        const input = skuInput.value.trim();
        errorMessage.style.display = "none";
        errorMessage.textContent = "";
        loading.style.display = "block";
        tableContainer.innerHTML = "";
        testedSKUs = [];
        localStorage.setItem("testedSKUs", JSON.stringify(testedSKUs));
        checkedSKUsDisplay.textContent = "Checked SKUs (no images): None";
        
        if (!input) {
          loading.style.display = "none";
          errorMessage.textContent = "Error: SKU cannot be empty.";
          errorMessage.style.display = "block";
          return;
        }
        
        if (!section.validationRegex.test(input)) {
          loading.style.display = "none";
          errorMessage.textContent = "Error: SKU must be a 5-digit number (e.g., 12345).";
          errorMessage.style.display = "block";
          return;
        }
        
        currentSKU = input;
        skuInput.value = currentSKU;
        localStorage.setItem("currentSKU", currentSKU);
        displayImages(currentSKU);
      }
      
      async function navigateSKU(direction) {
        if (isScanning) return;
        isScanning = true;
        lastSKU = currentSKU;
        abortController = new AbortController();
        cancelBtn.style.display = "inline-block";
        scanCount = 0;
        
        prevExteriorBtn.disabled = true;
        nextExteriorBtn.disabled = true;
        
        errorMessage.style.display = "none";
        errorMessage.textContent = "";
        loading.style.display = "block";
        tableContainer.innerHTML = "";
        
        console.log(`Starting scan from SKU ${currentSKU}, direction ${direction}, testedSKUs: ${testedSKUs.join(", ")}`);
        
        try {
          await navigateSKUInternal(direction);
        } catch (error) {
          console.error(`Scan error: ${error.message}`);
          isScanning = false;
          cancelBtn.style.display = "none";
          prevExteriorBtn.disabled = false;
          nextExteriorBtn.disabled = false;
          testedSKUs = [];
          localStorage.setItem("testedSKUs", JSON.stringify(testedSKUs));
          checkedSKUsDisplay.textContent = "Checked SKUs (no images): None";
          loading.style.display = "none";
          errorMessage.textContent = `Error during scan: ${error.message}`;
          errorMessage.style.display = "block";
        }
      }
      
      async function navigateSKUInternal(direction) {
        if (scanCount >= maxScanAttempts) {
          isScanning = false;
          cancelBtn.style.display = "none";
          prevExteriorBtn.disabled = false;
          nextExteriorBtn.disabled = false;
          loading.style.display = "none";
          errorMessage.textContent = "Error: No valid SKUs found after checking multiple options. Try a different range or manual entry.";
          errorMessage.style.display = "block";
          console.log(`Scan stopped: Reached maxScanAttempts (${maxScanAttempts})`);
          return;
        }
        
        let nextSKU = getNextSKU(currentSKU, direction);
        while (nextSKU !== null && testedSKUs.includes(nextSKU) && !abortController.signal.aborted) {
          console.log(`Skipping SKU ${nextSKU}: Already in testedSKUs`);
          nextSKU = getNextSKU(nextSKU, direction);
        }
        
        if (nextSKU === null || abortController.signal.aborted) {
          isScanning = false;
          cancelBtn.style.display = "none";
          prevExteriorBtn.disabled = false;
          nextExteriorBtn.disabled = false;
          loading.style.display = "none";
          if (nextSKU === null) {
            errorMessage.textContent = `Error: Reached ${direction > 0 ? "maximum" : "minimum"} SKU.`;
            errorMessage.style.display = "block";
            console.log(`Scan stopped: Reached ${direction > 0 ? "maximum" : "minimum"} SKU`);
          } else {
            console.log(`Scan stopped: Aborted`);
          }
          return;
        }
        
        scanCount++;
        console.log(`Checking SKU ${nextSKU}, scanCount: ${scanCount}`);
        const hasImages = await checkImages(nextSKU, abortController.signal);
        if (abortController.signal.aborted) {
          isScanning = false;
          cancelBtn.style.display = "none";
          prevExteriorBtn.disabled = false;
          nextExteriorBtn.disabled = false;
          loading.style.display = "none";
          console.log(`Scan aborted for SKU ${nextSKU}`);
          return;
        }
        
        if (hasImages) {
          currentSKU = nextSKU;
          skuInput.value = currentSKU;
          localStorage.setItem("currentSKU", currentSKU);
          if (!validSKUs.includes(nextSKU)) {
            validSKUs.push(nextSKU);
            localStorage.setItem("validSKUs", JSON.stringify(validSKUs));
            updateInteriorButtonState();
            updateValidSKUsRange();
          }
          console.log(`Found valid SKU ${nextSKU}, displaying images`);
          displayImages(currentSKU);
          isScanning = false;
          cancelBtn.style.display = "none";
          prevExteriorBtn.disabled = false;
          nextExteriorBtn.disabled = false;
          loading.style.display = "none";
          testedSKUs = [];
          localStorage.setItem("testedSKUs", JSON.stringify(testedSKUs));
          checkedSKUsDisplay.textContent = "Checked SKUs (no images): None";
        } else {
          console.log(`No images for SKU ${nextSKU}, adding to testedSKUs`);
          testedSKUs.push(nextSKU);
          localStorage.setItem("testedSKUs", JSON.stringify(testedSKUs));
          updateCheckedSKUsDisplay();
          await navigateSKUInternal(direction);
        }
      }
      
      function navigateValidSKU(direction) {
        if (validSKUs.length === 0) {
          errorMessage.style.display = "none";
          errorMessage.textContent = "Error: No valid SKUs with images found yet. Use exterior arrows to find some.";
          errorMessage.style.display = "block";
          loading.style.display = "none";
          console.log(`No valid SKUs for interior navigation`);
          return;
        }
        
        errorMessage.style.display = "none";
        errorMessage.textContent = "";
        loading.style.display = "block";
        tableContainer.innerHTML = "";
        
        const currentValue = skuToNumber(currentSKU);
        const candidates = validSKUs
          .map(sku => ({ sku, value: skuToNumber(sku) }))
          .filter(item => direction > 0 ? item.value > currentValue : item.value < currentValue)
          .sort((a, b) => direction > 0 ? a.value - b.value : b.value - a.value);
        
        if (candidates.length === 0) {
          loading.style.display = "none";
          errorMessage.textContent = `No more known SKUs with images in this direction. Use exterior arrows to find more.`;
          errorMessage.style.display = "block";
          console.log(`No more valid SKUs in direction ${direction}`);
          return;
        }
        
        currentSKU = candidates[0].sku;
        skuInput.value = currentSKU;
        localStorage.setItem("currentSKU", currentSKU);
        console.log(`Navigating to valid SKU ${currentSKU}`);
        displayImages(currentSKU);
      }
      
      function skuToNumber(sku) {
        return parseInt(sku, 10);
      }
      
      function getNextSKU(sku, direction) {
        if (!section.validationRegex.test(sku)) {
          return "00000";
        }
        
        const num = parseInt(sku, 10);
        const nextNum = num + direction;
        
        if (nextNum < 0 || nextNum > 99999) {
          return null;
        }
        
        return nextNum.toString().padStart(5, "0");
      }
      
      async function checkImages(sku, signal) {
        const urls = [`/api/fetch-image?sku=${sku}&size=100&type=.png`];
        let hasImages = false;
        
        for (const url of urls) {
          let attempts = 0;
          const maxAttempts = 3;
          
          while (attempts < maxAttempts && !signal.aborted) {
            const timeoutController = new AbortController();
            const timeoutId = setTimeout(() => timeoutController.abort(), section.fetchTimeout);
            
            try {
              const response = await fetch(url, { 
                method: 'GET', 
                signal: AbortSignal.any([signal, timeoutController.signal])
              });
              console.log(`Checking ${url}: Status ${response.status}, Attempt ${attempts + 1}`);
              if (response.ok) {
                try {
                  const data = await response.json();
                  if (data.isBase64Encoded) {
                    hasImages = true;
                  } else {
                    console.log(`Invalid response for ${url}: Not base64 encoded`);
                    hasImages = false;
                  }
                } catch (error) {
                  console.error(`Error parsing JSON for ${url}: ${error.message}`);
                  hasImages = false;
                }
              } else if ([429, 503].includes(response.status)) {
                console.log(`Retrying ${url}: Status ${response.status}`);
                attempts++;
                await new Promise(resolve => setTimeout(resolve, 1000));
                continue;
              } else {
                console.log(`Failed to fetch ${url}: Status ${response.status}`);
                break;
              }
            } catch (error) {
              console.error(`Error checking ${url}: ${error.message}, Attempt ${attempts + 1}`);
              if (error.name === "AbortError" && !signal.aborted) {
                console.log(`Timeout for ${url}, retrying...`);
                attempts++;
                await new Promise(resolve => setTimeout(resolve, 1000));
                continue;
              } else if (error.name === "AbortError") {
                clearTimeout(timeoutId);
                throw error;
              }
              break;
            } finally {
              clearTimeout(timeoutId);
            }
            if (hasImages) break;
          }
          if (hasImages) break;
          await new Promise(resolve => setTimeout(resolve, 500));
        }
        
        console.log(`checkImages for SKU ${sku}: ${hasImages ? "Valid" : "Invalid"}`);
        if (!hasImages) {
          errorMessage.textContent = `Error: No images found for SKU ${sku}. The SKU may not exist or the server is unavailable.`;
          errorMessage.style.display = "block";
        }
        return hasImages;
      }
      
async function displayImages(sku) {
  tableContainer.innerHTML = "";
  productTitle.style.display = "none";
  productTitle.innerHTML = "";
  let loadedImages = 0;
  let failedImages = 0;
  const displaySizes = showAllSizes ? section.sizes : [section.sizes[0]];
  const totalImages = displaySizes.length * section.fileTypes.length;
  const missingImages = [];
  
  if (!sku || typeof sku !== 'string' || !/^[0-9]{5}$/.test(sku)) {
    loading.style.display = "none";
    errorMessage.textContent = "Error: Invalid SKU provided";
    errorMessage.style.display = "block";
    console.error('Invalid SKU provided');
    return;
  }

    // Fetch product title
  try {
    const response = await fetch(`/api/fetch-image?sku=${sku}&action=getProductTitle`, { method: "GET" });
    console.log(`Fetching title for SKU ${sku}: Status ${response.status}`);
    if (response.ok) {
      const data = await response.json();
      if (data.title) {
        productTitle.innerHTML = `<p><strong>Product:</strong> ${data.title}</p>`;
        productTitle.style.display = "block";
      } else {
        console.log(`No title found for SKU ${sku}`);
      }
    } else {
      console.log(`Failed to fetch title for SKU ${sku}: Status ${response.status}`);
    }
  } catch (error) {
    console.error(`Error fetching title for SKU ${sku}: ${error.message}`);
  }
  
    // Create container structure
    const imgContainer = document.createElement("div");
    imgContainer.classList.add("img-container");
    tableContainer.appendChild(imgContainer);



    // Helper functions
    const createImageElement = (heading, imageUrl) => {
        const img = document.createElement("img");
        img.alt = `${heading} for SKU ${sku}`;
        img.classList.add("default-image");
        return img;
    };

    const handleImageError = (heading, errorText) => {
        failedImages++;
        missingImages.push(heading);
        
        const errorDiv = document.createElement("div");
        errorDiv.classList.add("image-error");
        errorDiv.textContent = errorText;
        return errorDiv;
    };

    const updateCompletionStatus = () => {
        loading.style.display = "none";
        
        if (loadedImages === 0) {
            errorMessage.textContent = `Error: No images found for SKU ${sku}. The SKU may not exist or the server is unavailable.`;
            errorMessage.style.display = "block";
            return;
        }
        
        if (missingImages.length > 0) {
            errorMessage.textContent = `Warning: Some images missing for SKU ${sku}: ${missingImages.join(", ")}`;
            errorMessage.style.display = "block";
        }

        if (loadedImages > 0 && !validSKUs.includes(sku)) {
            validSKUs.push(sku);
            localStorage.setItem("validSKUs", JSON.stringify(validSKUs));
            updateInteriorButtonState();
            updateValidSKUsRange();
        }
    };

    try {
        // Process images
        for (const size of displaySizes) {
            for (const type of section.fileTypes) {
                const innerCard = document.createElement("div");
                innerCard.classList.add("inner-card");
                imgContainer.appendChild(innerCard);

                const heading = `${size}${type}`;
                const imageUrl = `${section.baseURL}${sku}/${size}${type}`;

                // Add heading
                innerCard.innerHTML += `<h3><a href="${imageUrl}" target="_blank" rel="noopener noreferrer">${heading}</a></h3>`;

                // Fetch image
                const imgSrc = `/api/fetch-image?sku=${sku}&size=${size}&type=${type}`;
                
                try {
                    const response = await fetch(imgSrc, { method: 'GET' });
                    
                    if (!response.ok) {
                        throw new Error(`Failed to fetch image: Status ${response.status}`);
                    }

                    const data = await response.json();

                    if (!data.isBase64Encoded) {
                        throw new Error('Response is not base64 encoded');
                    }

                    const img = createImageElement(heading, imageUrl);
                    img.src = `data:${data.contentType};base64,${data.body}`;
                    innerCard.appendChild(img);

                    img.onload = () => {
                        loadedImages++;
                        console.log(`Loaded ${imgSrc}`);
                        
                        if (loadedImages + failedImages === totalImages) {
                            updateCompletionStatus();
                        }
                    };

                    img.onerror = () => {
                        const errorDiv = handleImageError(heading, `Image not found for ${heading}`);
                        innerCard.removeChild(img);
                        innerCard.appendChild(errorDiv);
                        
                        if (loadedImages + failedImages === totalImages) {
                            updateCompletionStatus();
                        }
                    };

                } catch (error) {
                    const errorDiv = handleImageError(heading, `Failed to load ${heading}: ${error.message}`);
                    innerCard.appendChild(errorDiv);
                    
                    if (loadedImages + failedImages === totalImages) {
                        updateCompletionStatus();
                    }
                }
            }
        }

      
      function updateCheckedSKUsDisplay() {
        if (testedSKUs.length === 0) {
          checkedSKUsDisplay.textContent = "Checked SKUs (no images): None";
        } else {
          checkedSKUsDisplay.textContent = `Checked SKUs (no images): ${testedSKUs.join(", ")}`;
        }
      }
      
      function updateValidSKUsRange() {
        if (validSKUs.length === 0) {
          validSKUsRangeDisplay.textContent = "Known SKUs with images: None";
        } else {
          const sortedSKUs = validSKUs.sort((a, b) => skuToNumber(a) - skuToNumber(b));
          validSKUsRangeDisplay.textContent = `Known SKUs with images: Min: ${sortedSKUs[0]}, Max: ${sortedSKUs[sortedSKUs.length - 1]}`;
        }
      }
      
      function updateInteriorButtonState() {
        prevInteriorBtn.disabled = validSKUs.length === 0;
        nextInteriorBtn.disabled = validSKUs.length === 0;
      }
      
      function clearForm() {
        skuInput.value = "00000";
        currentSKU = "00000";
        localStorage.setItem("currentSKU", currentSKU);
        errorMessage.style.display = "none";
        errorMessage.textContent = "";
        loading.style.display = "none";
        cancelBtn.style.display = "none";
        tableContainer.innerHTML = "";
        testedSKUs = [];
        validSKUs = [];
        localStorage.setItem("testedSKUs", JSON.stringify(testedSKUs));
        localStorage.setItem("validSKUs", JSON.stringify(validSKUs));
        isScanning = false;
        showAllSizes = false;
        sizesBtn.textContent = "Sizes";
        sizesBtn.setAttribute("aria-expanded", "false");
        sizesBtn.setAttribute("aria-label", "Show additional image sizes");
        if (abortController) {
          abortController.abort();
          abortController = null;
        }
        updateCheckedSKUsDisplay();
        updateValidSKUsRange();
        updateInteriorButtonState();
      }
      
      function cancelScan() {
        if (!isScanning || !abortController) return;
        abortController.abort();
        abortController = null;
        isScanning = false;
        cancelBtn.style.display = "none";
        prevExteriorBtn.disabled = false;
        nextExteriorBtn.disabled = false;
        loading.style.display = "none";
        errorMessage.style.display = "none";
        errorMessage.textContent = "";
        currentSKU = lastSKU;
        skuInput.value = currentSKU;
        localStorage.setItem("currentSKU", currentSKU);
        console.log(`Scan cancelled, reverting to SKU ${currentSKU}`);
        displayImages(currentSKU);
      }
    </script>
  </body>
</html>
