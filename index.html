<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>ImageScraper by Tate</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
      html, body {
        font-family: system-ui;
        margin: 0;
        padding: 0;
        text-align: center;
        background-color: #e8e8e8;
        color: #000000;
        min-height: 100vh;
      }
      
      body {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }
      
      main {
        flex: 1 0 auto;
      }
      
      footer {
        flex-shrink: 0;
        font-size: 12pt;
        text-align: center;
        padding: 10px;
        color: #000000;
      }
      
      .dark-theme footer {
        color: #ffffff;
      }
      
      h1 {
        margin-top: 0;
      }
      
      .dark-theme {
        background: url('https://auth.ifsta.org/images/background_e8.jpg') no-repeat center center fixed;
        background-size: cover;
        color: #ffffff;
      }
      
      #formID {
        font-size: 16pt;
        margin: 20px 0;
      }
      
      .img-container {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
      }
      
      .inner-card {
        display: inline-block;
        text-align: center;
        background-color: #abebff;
        margin: 10px;
        padding: 10px;
      }
      
      .dark-theme .inner-card {
        background-color: #cbccce;
      }
      
      .inner-card h3 {
        color: #000000;
      }
      
      #error-message {
        color: red;
        font-size: 14pt;
        margin-top: 10px;
        display: none;
      }
      
      .dark-theme #error-message {
        color: #ff9999;
      }
      
      #product-title {
        font-size: 16pt;
        margin: 10px 0;
        display: none;
      }
      
      .dark-theme #product-title {
        color: #ffffff;
      }
      
      #product-title p {
        margin: 5px 0;
      }
      
      .btn {
        font-size: 14pt;
        margin: 0 5px;
        padding: 5px 15px;
        cursor: pointer;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
      }
      
      .btn:hover {
        background-color: #0056b3;
      }
      
      .dark-theme .btn {
        background-color: #b32318;
      }
      
      .dark-theme .btn:hover {
        background-color: #8e1c13;
      }
      
      .btn:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
        color: #666666;
      }
      
      .dark-theme .btn:disabled {
        color: #999999;
      }
      
      #cancel-btn, #batch-download-btn {
        background-color: #dc3545;
      }
      
      .dark-theme #cancel-btn, .dark-theme #batch-download-btn {
        background-color: #b32318;
      }
      
      #cancel-btn:hover, #batch-download-btn:hover {
        background-color: #c82333;
      }
      
      .dark-theme #cancel-btn:hover, .dark-theme #batch-download-btn:hover {
        background-color: #8e1c13;
      }
      
      #theme-btn, #download-btn, #batch-save-btn, #search-btn {
        position: absolute;
        top: 10px;
        background-color: #17a2b8;
        font-size: 12pt;
        padding: 8px;
        display: none;
      }
      
      #theme-btn {
        right: 10px;
      }
      
      #download-btn {
        right: 50px;
      }
      
      #batch-save-btn {
        right: 90px;
      }
      
      #search-btn {
        right: 130px;
      }
      
      #theme-btn:hover, #download-btn:hover, #batch-save-btn:hover, #search-btn:hover {
        background-color: #138496;
      }
      
      .dark-theme #theme-btn, .dark-theme #download-btn, .dark-theme #batch-save-btn, .dark-theme #search-btn {
        background-color: #b32318;
      }
      
      .dark-theme #theme-btn:hover, .dark-theme #download-btn:hover, .dark-theme #batch-save-btn:hover, .dark-theme #search-btn:hover {
        background-color: #8e1c13;
      }
      
      #theme-label {
        position: absolute;
        top: 12px;
        right: 50px;
        font-size: 12pt;
        color: #000000;
      }
      
      .dark-theme #theme-label {
        color: #ffffff;
      }
      
      #batch-modal {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: #ffffff;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        z-index: 1000;
        max-width: 500px;
        width: 90%;
      }
      
      .dark-theme #batch-modal {
        background-color: #333333;
        color: #ffffff;
      }
      
      #batch-modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 999;
      }
      
      #batch-sku-input {
        font-size: 14pt;
        margin: 10px 0;
        padding: 5px;
        width: 100%;
        color: #000000;
      }
      
      .dark-theme #batch-sku-input {
        background-color: #444444;
        color: #ffffff;
        border: 1px solid #ffffff;
      }
      
      #batch-error {
        color: red;
        font-size: 12pt;
        margin: 10px 0;
        display: none;
      }
      
      .dark-theme #batch-error {
        color: #ff9999;
      }
      
      #batch-sku-list {
        max-height: 200px;
        overflow-y: auto;
        margin: 10px 0;
        padding: 10px;
        background-color: #f0f0f0;
        border: 1px solid #cccccc;
      }
      
      .dark-theme #batch-sku-list {
        background-color: #444444;
        border: 1px solid #ffffff;
      }
      
      #batch-sku-list div {
        margin: 5px 0;
      }
      
      img {
        max-width: 100%;
        height: auto;
        display: block;
      }
      
      .default-image {
        max-width: 400px;
      }
      
      .image-error {
        color: red;
        font-size: 12pt;
        margin: 10px 0;
      }
      
      .dark-theme .image-error {
        color: #ff9999;
      }
      
      #loading {
        font-size: 14pt;
        margin-top: 10px;
        display: none;
      }
      
      .dark-theme #loading {
        color: #ffffff;
      }
      
      #sku-input {
        font-size: 16pt;
        margin: 0 5px;
        padding: 5px;
        width: 100px;
        text-align: center;
        color: #000000;
      }
      
      .dark-theme #sku-input {
        color: #ffffff;
        background-color: #333333;
        border: 1px solid #ffffff;
      }
      
      #checked-skus, #valid-skus-range {
        font-size: 14pt;
        margin-top: 10px;
        max-width: 600px;
        margin-left: auto;
        margin-right: auto;
        word-wrap: break-word;
      }
      
      .dark-theme #checked-skus,
      .dark-theme #valid-skus-range {
        color: #ffffff;
      }
      
      .dark-theme h1,
      .dark-theme h2 {
        color: #ffffff;
      }
      
      #cancel-btn, #batch-download-btn {
        display: none;
      }
    </style>
  </head>
  <body>
    <main>
      <button id="search-btn" class="btn" aria-label="Search IFSTA for SKU"><i class="fas fa-globe"></i></button>
      <button id="download-btn" class="btn" aria-label="Download PNG images as ZIP"><i class="fas fa-cloud-arrow-down"></i></button>
      <button id="batch-save-btn" class="btn" aria-label="Open batch SKU modal"><i class="fas fa-save"></i></button>
      <button id="theme-btn" class="btn" aria-label="Switch to dark theme"><i class="fas fa-paint-brush"></i></button>
      <span id="theme-label">Theme</span>
      <h1>Welcome to ImageScraper!</h1>
      <h2>By Tate</h2>
      <div id="formID">
        <button id="sizes-btn" class="btn" aria-label="Show additional image sizes" aria-expanded="false">Sizes</button>
        <button id="prev-exterior-btn" class="btn" aria-label="Previous Untested Product">≪</button>
        <button id="prev-interior-btn" class="btn" aria-label="Previous Valid Product" disabled>←</button>
        <input type="text" id="sku-input" aria-required="true" value="00000">
        <button id="next-interior-btn" class="btn" aria-label="Next Valid Product" disabled>→</button>
        <button id="next-exterior-btn" class="btn" aria-label="Next Untested Product">≫</button>
        <button id="submit-btn" class="btn" aria-label="Submit SKU">Go</button>
        <button id="clear-btn" class="btn" aria-label="Clear input and images">Clear</button>
        <button id="cancel-btn" class="btn" aria-label="Cancel ongoing scan">Cancel</button>
        <button id="batch-download-btn" class="btn" aria-label="Batch Download SKUs">Batch Download</button>
      </div>
      <div id="error-message" aria-live="polite"></div>
      <div id="product-title"></div>
      <div id="tableID"></div>
      <div id="loading">Loading...</div>
      <div id="batch-modal-overlay"></div>
      <div id="batch-modal">
        <h3>Batch SKUs</h3>
        <input type="text" id="batch-sku-input" placeholder="Enter SKUs (comma-separated)">
        <div id="batch-error"></div>
        <div id="batch-sku-list"></div>
        <button id="batch-add-btn" class="btn">Add SKUs</button>
        <button id="batch-cancel-btn" class="btn">Cancel</button>
      </div>
      <div id="checked-skus">Checked SKUs (no images): None</div>
      <div id="valid-skus-range">Known SKUs with images: None</div>
    </main>
    <footer id="footer" aria-label="IFSTA Copyright 2025">
      IFSTA © 2025 <a href="https://github.com/aaronfpp/image-scraper">GitHub</a>
    </footer>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script type="text/javascript">
      const section = {
        baseURL: "https://images.ifsta.org/products/",
        sizes: ["default", "thumb", "69", "100", "130", "150", "180", "200", "200x200", "420"],
        fileTypes: [".png", ".webp"],
        inputLabel: "SKU",
        validationRegex: /^[0-9]{5}$/,
        fetchTimeout: 5000
      };
      
      const themeBtn = document.getElementById("theme-btn");
      const downloadBtn = document.getElementById("download-btn");
      const searchBtn = document.getElementById("search-btn");
      const batchSaveBtn = document.getElementById("batch-save-btn");
      const batchModal = document.getElementById("batch-modal");
      const batchModalOverlay = document.getElementById("batch-modal-overlay");
      const batchSKUInput = document.getElementById("batch-sku-input");
      const batchAddBtn = document.getElementById("batch-add-btn");
      const batchCancelBtn = document.getElementById("batch-cancel-btn");
      const batchSKUList = document.getElementById("batch-sku-list");
      const batchError = document.getElementById("batch-error");
      const sizesBtn = document.getElementById("sizes-btn");
      const prevExteriorBtn = document.getElementById("prev-exterior-btn");
      const nextExteriorBtn = document.getElementById("next-exterior-btn");
      const prevInteriorBtn = document.getElementById("prev-interior-btn");
      const nextInteriorBtn = document.getElementById("next-interior-btn");
      const skuInput = document.getElementById("sku-input");
      const submitBtn = document.getElementById("submit-btn");
      const clearBtn = document.getElementById("clear-btn");
      const cancelBtn = document.getElementById("cancel-btn");
      const errorMessage = document.getElementById("error-message");
      const productTitle = document.getElementById("product-title");
      const loading = document.getElementById("loading");
      const tableContainer = document.getElementById("tableID");
      const checkedSKUsDisplay = document.getElementById("checked-skus");
      const validSKUsRangeDisplay = document.getElementById("valid-skus-range");
      const themeLabel = document.getElementById("theme-label");
      
      let testedSKUs = [];
      let validSKUs = [];
      let batchSKUs = [];
      let currentSKU = localStorage.getItem("currentSKU") && section.validationRegex.test(localStorage.getItem("currentSKU")) ? localStorage.getItem("currentSKU") : "00000";
      let isScanning = false;
      let abortController = null;
      let lastSKU = currentSKU;
      let scanCount = 0;
      const maxScanAttempts = 100;
      let showAllSizes = false;
      let isDarkTheme = false;
      
      skuInput.value = currentSKU;
      
      themeBtn.addEventListener("click", toggleTheme);
      downloadBtn.addEventListener("click", downloadImagesAsZip);
      batchSaveBtn.addEventListener("click", openBatchModal);
      batchAddBtn.addEventListener("click", addBatchSKUs);
      batchCancelBtn.addEventListener("click", closeBatchModal);
      batchModalOverlay.addEventListener("click", closeBatchModal);
      searchBtn.addEventListener("click", searchIFSTA);
      sizesBtn.addEventListener("click", toggleSizes);
      prevExteriorBtn.addEventListener("click", () => navigateSKU(-1));
      nextExteriorBtn.addEventListener("click", () => navigateSKU(1));
      prevInteriorBtn.addEventListener("click", () => navigateValidSKU(-1));
      nextInteriorBtn.addEventListener("click", () => navigateValidSKU(1));
      submitBtn.addEventListener("click", submitSKU);
      skuInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") submitSKU();
      });
      clearBtn.addEventListener("click", clearForm);
      cancelBtn.addEventListener("click", cancelScan);
      batchDownloadBtn.addEventListener("click", batchDownloadSKUs);
      
      displayImages(currentSKU);
      
      function toggleTheme() {
        isDarkTheme = !isDarkTheme;
        document.body.classList.toggle("dark-theme");
        themeBtn.setAttribute("aria-label", isDarkTheme ? "Switch to light theme" : "Switch to dark theme");
        themeLabel.textContent = isDarkTheme ? "Light" : "Dark";
      }
      
      function openBatchModal() {
        batchModal.style.display = "block";
        batchModalOverlay.style.display = "block";
        batchSKUInput.value = batchSKUs.join(", ");
        updateBatchSKUList();
      }
      
      function closeBatchModal() {
        batchModal.style.display = "none";
        batchModalOverlay.style.display = "none";
        batchError.style.display = "none";
        batchSKUInput.value = "";
      }
      
      function updateBatchSKUList() {
        batchSKUList.innerHTML = batchSKUs.length > 0
          ? batchSKUs.map(sku => `<div>${sku}</div>`).join("")
          : "<div>No SKUs added</div>";
      }
      
      async function addBatchSKUs() {
        const input = batchSKUInput.value.trim();
        batchError.style.display = "none";
        batchError.textContent = "";
        
        if (!input) {
          batchError.textContent = "Error: Please enter at least one SKU.";
          batchError.style.display = "block";
          return;
        }
        
        const skus = input.split(",").map(s => s.trim()).filter(s => s);
        const invalidSKUs = skus.filter(sku => !section.validationRegex.test(sku));
        if (invalidSKUs.length > 0) {
          batchError.textContent = `Error: Invalid SKUs: ${invalidSKUs.join(", ")}. SKUs must be 5-digit numbers.`;
          batchError.style.display = "block";
          return;
        }
        
        const uniqueNewSKUs = skus.filter(sku => !batchSKUs.includes(sku));
        if (uniqueNewSKUs.length === 0) {
          batchError.textContent = "Error: All entered SKUs are already in the batch.";
          batchError.style.display = "block";
          return;
        }
        
        batchSKUs.push(...uniqueNewSKUs);
        updateBatchSKUList();
        batchSKUInput.value = "";
        batchDownloadBtn.style.display = batchSKUs.length > 0 ? "inline-block" : "none";
        batchError.textContent = `Added ${uniqueNewSKUs.length} SKU(s) to batch.`;
        batchError.style.display = "block";
      }
      
      function searchIFSTA() {
        const searchUrl = `https://www.ifsta.org/shop/product/${currentSKU}`;
        window.open(searchUrl, '_blank');
      }
      
      async function batchDownloadSKUs() {
        if (batchSKUs.length === 0) {
          errorMessage.textContent = "Error: No SKUs in batch to download.";
          errorMessage.style.display = "block";
          return;
        }
        
        batchDownloadBtn.disabled = true;
        errorMessage.style.display = "none";
        errorMessage.textContent = "";
        loading.style.display = "block";
        
        const zip = new JSZip();
        let hasImages = false;
        const missingSKUs = [];
        
        for (const sku of batchSKUs) {
          const folder = zip.folder(sku);
          const missingImages = [];
          
          for (const size of section.sizes) {
            for (const type of section.fileTypes) {
              const url = `/api/fetch-image?sku=${sku}&size=${size}&type=${type}`;
              const fileName = `${size}${type}`;
              
              try {
                const response = await fetch(url, { method: "GET" });
                console.log(`Fetching ${url}: Status ${response.status}`);
                if (response.ok) {
                  const data = await response.json();
                  if (data.isBase64Encoded) {
                    const binaryString = atob(data.body);
                    const len = binaryString.length;
                    const bytes = new Uint8Array(len);
                    for (let i = 0; i < len; i++) {
                      bytes[i] = binaryString.charCodeAt(i);
                    }
                    const blob = new Blob([bytes], { type: data.contentType });
                    folder.file(fileName, blob);
                    hasImages = true;
                  } else {
                    throw new Error('Response is not base64 encoded');
                  }
                } else {
                  missingImages.push(`${size}${type}`);
                  console.log(`Failed to fetch ${url}: Status ${response.status}`);
                }
              } catch (error) {
                missingImages.push(`${size}${type}`);
                console.error(`Error fetching ${url}: ${error.message}`);
              }
            }
          }
          
          if (missingImages.length === section.sizes.length * section.fileTypes.length) {
            missingSKUs.push(sku);
          }
        }
        
        if (!hasImages) {
          loading.style.display = "none";
          errorMessage.textContent = `Error: No images found for batch SKUs: ${missingSKUs.join(", ")}`;
          errorMessage.style.display = "block";
          batchDownloadBtn.disabled = false;
          return;
        }
        
        try {
          const content = await zip.generateAsync({ type: "blob" });
          saveAs(content, `batch_images_${new Date().toISOString().split('T')[0]}.zip`);
          if (missingSKUs.length > 0) {
            errorMessage.textContent = `Warning: No images found for SKUs: ${missingSKUs.join(", ")}`;
            errorMessage.style.display = "block";
          }
        } catch (error) {
          console.error(`Error generating ZIP: ${error.message}`);
          errorMessage.textContent = "Error: Failed to generate batch ZIP file.";
          errorMessage.style.display = "block";
        }
        
        loading.style.display = "none";
        batchDownloadBtn.disabled = false;
      }
      
      async function downloadImagesAsZip() {
        downloadBtn.disabled = true;
        errorMessage.style.display = "none";
        errorMessage.textContent = "";
        loading.style.display = "block";
        
        const zip = new JSZip();
        let hasImages = false;
        const missingImages = [];
        
        for (const size of section.sizes) {
          for (const type of section.fileTypes) {
            const url = `/api/fetch-image?sku=${currentSKU}&size=${size}&type=${type}`;
            const fileName = `${currentSKU}_${size}${type}`;
            
            try {
              const response = await fetch(url, { method: "GET" });
              console.log(`Fetching ${url}: Status ${response.status}`);
              if (response.ok) {
                const data = await response.json();
                if (data.isBase64Encoded) {
                  const binaryString = atob(data.body);
                  const len = binaryString.length;
                  const bytes = new Uint8Array(len);
                  for (let i = 0; i < len; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                  }
                  const blob = new Blob([bytes], { type: data.contentType });
                  zip.file(fileName, blob);
                  hasImages = true;
                } else {
                  throw new Error('Response is not base64 encoded');
                }
              } else {
                missingImages.push(`${size}${type}`);
                console.log(`Failed to fetch ${url}: Status ${response.status}`);
              }
            } catch (error) {
              missingImages.push(`${size}${type}`);
              console.error(`Error fetching ${url}: ${error.message}`);
            }
          }
        }
        
        if (!hasImages) {
          loading.style.display = "none";
          errorMessage.textContent = `Error: No images found for SKU ${currentSKU}. Missing: ${missingImages.join(", ")}`;
          errorMessage.style.display = "block";
          downloadBtn.disabled = false;
          return;
        }
        
        try {
          const content = await zip.generateAsync({ type: "blob" });
          saveAs(content, `images_${currentSKU}.zip`);
          if (missingImages.length > 0) {
            errorMessage.textContent = `Warning: Some images missing for SKU ${currentSKU}: ${missingImages.join(", ")}`;
            errorMessage.style.display = "block";
          }
        } catch (error) {
          console.error(`Error generating ZIP: ${error.message}`);
          errorMessage.textContent = "Error: Failed to generate ZIP file.";
          errorMessage.style.display = "block";
        }
        
        loading.style.display = "none";
        downloadBtn.disabled = false;
      }
      
      async function submitSKU() {
        const input = skuInput.value.trim();
        errorMessage.style.display = "none";
        errorMessage.textContent = "";
        loading.style.display = "block";
        tableContainer.innerHTML = "";
        testedSKUs = [];
        checkedSKUsDisplay.textContent = "Checked SKUs (no images): None";
        
        if (!input) {
          loading.style.display = "none";
          errorMessage.textContent = "Error: SKU cannot be empty.";
          errorMessage.style.display = "block";
          return;
        }
        
        if (!section.validationRegex.test(input)) {
          loading.style.display = "none";
          errorMessage.textContent = "Error: SKU must be a 5-digit number (e.g., 12345).";
          errorMessage.style.display = "block";
          return;
        }
        
        currentSKU = input;
        skuInput.value = currentSKU;
        localStorage.setItem("currentSKU", currentSKU);
        displayImages(currentSKU);
      }
      
      async function navigateSKU(direction) {
        if (isScanning) return;
        isScanning = true;
        lastSKU = currentSKU;
        abortController = new AbortController();
        cancelBtn.style.display = "inline-block";
        batchDownloadBtn.style.display = "none";
        scanCount = 0;
        
        prevExteriorBtn.disabled = true;
        nextExteriorBtn.disabled = true;
        
        errorMessage.style.display = "none";
        errorMessage.textContent = "";
        loading.style.display = "block";
        tableContainer.innerHTML = "";
        
        console.log(`Starting scan from SKU ${currentSKU}, direction ${direction}, testedSKUs: ${testedSKUs.join(", ")}`);
        
        await navigateSKUInternal(direction);
        
        isScanning = false;
        cancelBtn.style.display = "none";
        batchDownloadBtn.style.display = batchSKUs.length > 0 ? "inline-block" : "none";
        prevExteriorBtn.disabled = false;
        nextExteriorBtn.disabled = false;
        testedSKUs = [];
        checkedSKUsDisplay.textContent = "Checked SKUs (no images): None";
      }
      
      async function navigateSKUInternal(direction) {
        if (scanCount >= maxScanAttempts) {
          isScanning = false;
          cancelBtn.style.display = "none";
          batchDownloadBtn.style.display = batchSKUs.length > 0 ? "inline-block" : "none";
          loading.style.display = "none";
          errorMessage.textContent = "Error: No valid SKUs found after checking multiple options. Try a different range or manual entry.";
          errorMessage.style.display = "block";
          console.log(`Scan stopped: Reached maxScanAttempts (${maxScanAttempts})`);
          return;
        }
        
        let nextSKU = getNextSKU(currentSKU, direction);
        while (nextSKU !== null && testedSKUs.includes(nextSKU) && !abortController.signal.aborted) {
          console.log(`Skipping SKU ${nextSKU}: Already in testedSKUs`);
          nextSKU = getNextSKU(nextSKU, direction);
        }
        
        if (nextSKU === null || abortController.signal.aborted) {
          isScanning = false;
          cancelBtn.style.display = "none";
          batchDownloadBtn.style.display = batchSKUs.length > 0 ? "inline-block" : "none";
          loading.style.display = "none";
          if (nextSKU === null) {
            errorMessage.textContent = `Error: Reached ${direction > 0 ? "maximum" : "minimum"} SKU.`;
            errorMessage.style.display = "block";
            console.log(`Scan stopped: Reached ${direction > 0 ? "maximum" : "minimum"} SKU`);
          } else {
            console.log(`Scan stopped: Aborted`);
          }
          return;
        }
        
        scanCount++;
        console.log(`Checking SKU ${nextSKU}, scanCount: ${scanCount}`);
        const hasImages = await checkImages(nextSKU, abortController.signal);
        if (abortController.signal.aborted) {
          isScanning = false;
          cancelBtn.style.display = "none";
          batchDownloadBtn.style.display = batchSKUs.length > 0 ? "inline-block" : "none";
          loading.style.display = "none";
          console.log(`Scan aborted for SKU ${nextSKU}`);
          return;
        }
        
        if (hasImages) {
          currentSKU = nextSKU;
          skuInput.value = currentSKU;
          localStorage.setItem("currentSKU", currentSKU);
          if (!validSKUs.includes(nextSKU)) {
            validSKUs.push(nextSKU);
            updateInteriorButtonState();
            updateValidSKUsRange();
          }
          console.log(`Found valid SKU ${nextSKU}, displaying images`);
          displayImages(currentSKU);
        } else {
          console.log(`No images for SKU ${nextSKU}, adding to testedSKUs`);
          testedSKUs.push(nextSKU);
          updateCheckedSKUsDisplay();
          await navigateSKUInternal(direction);
        }
      }
      
      function navigateValidSKU(direction) {
        if (validSKUs.length === 0) {
          errorMessage.style.display = "none";
          errorMessage.textContent = "Error: No valid SKUs with images found yet. Use exterior arrows to find some.";
          errorMessage.style.display = "block";
          loading.style.display = "none";
          console.log(`No valid SKUs for interior navigation`);
          return;
        }
        
        errorMessage.style.display = "none";
        errorMessage.textContent = "";
        loading.style.display = "block";
        tableContainer.innerHTML = "";
        
        const currentValue = skuToNumber(currentSKU);
        const candidates = validSKUs
          .map(sku => ({ sku, value: skuToNumber(sku) }))
          .filter(item => direction > 0 ? item.value > currentValue : item.value < currentValue)
          .sort((a, b) => direction > 0 ? a.value - b.value : b.value - a.value);
        
        if (candidates.length === 0) {
          loading.style.display = "none";
          errorMessage.textContent = `No more known SKUs with images in this direction. Use exterior arrows to find more.`;
          errorMessage.style.display = "block";
          console.log(`No more valid SKUs in direction ${direction}`);
          return;
        }
        
        currentSKU = candidates[0].sku;
        skuInput.value = currentSKU;
        localStorage.setItem("currentSKU", currentSKU);
        console.log(`Navigating to valid SKU ${currentSKU}`);
        displayImages(currentSKU);
      }
      
      function skuToNumber(sku) {
        return parseInt(sku, 10);
      }
      
      function getNextSKU(sku, direction) {
        if (!section.validationRegex.test(sku)) {
          return "00000";
        }
        
        const num = parseInt(sku, 10);
        const nextNum = num + direction;
        
        if (nextNum < 0 || nextNum > 99999) {
          return null;
        }
        
        return nextNum.toString().padStart(5, "0");
      }
      
      async function checkImages(sku, signal) {
        const urls = section.fileTypes.map(type => `/api/fetch-image?sku=${sku}&size=100&type=${type}`);
        let hasImages = false;
        
        const timeoutController = new AbortController();
        const timeoutId = setTimeout(() => timeoutController.abort(), section.fetchTimeout);
        
        for (const url of urls) {
          let attempts = 0;
          const maxAttempts = 2;
          
          while (attempts < maxAttempts) {
            try {
              const response = await fetch(url, { 
                method: 'GET', 
                signal: AbortSignal.any([signal, timeoutController.signal])
              });
              console.log(`Checking ${url}: Status ${response.status}, Attempt ${attempts + 1}`);
              if (response.ok) {
                try {
                  const data = await response.json();
                  if (data.isBase64Encoded) {
                    hasImages = true;
                  } else {
                    console.log(`Invalid response for ${url}: Not base64 encoded`);
                    hasImages = true;
                  }
                } catch (error) {
                  console.error(`Error parsing JSON for ${url}: ${error.message}`);
                  hasImages = true;
                }
              } else if ([429, 503].includes(response.status)) {
                console.log(`Retrying ${url}: Status ${response.status}`);
                attempts++;
                await new Promise(resolve => setTimeout(resolve, 500));
              } else {
                console.log(`Failed to fetch ${url}: Status ${response.status}`);
                break;
              }
            } catch (error) {
              console.error(`Error checking ${url}: ${error.message}, Attempt ${attempts + 1}`);
              if (error.name === "AbortError") {
                clearTimeout(timeoutId);
                throw error;
              }
              attempts++;
              await new Promise(resolve => setTimeout(resolve, 500));
            }
          }
          if (hasImages) break;
          await new Promise(resolve => setTimeout(resolve, 500));
        }
        
        clearTimeout(timeoutId);
        console.log(`checkImages for SKU ${sku}: ${hasImages ? "Valid" : "Invalid"}`);
        if (!hasImages) {
          errorMessage.textContent = `Error: No images found for SKU ${sku}. The SKU may not exist or the server is unavailable.`;
          errorMessage.style.display = "block";
        }
        return hasImages;
      }
      
      async function displayImages(sku) {
        productTitle.style.display = "none";
        productTitle.innerHTML = "";
        tableContainer.innerHTML = "";
        let loadedImages = 0;
        let failedImages = 0;
        const displaySizes = showAllSizes ? section.sizes : [section.sizes[0]];
        const totalImages = displaySizes.length * section.fileTypes.length;
        const missingImages = [];
        
        // Fetch product title and additional data
        try {
          const response = await fetch(`/api/fetch-image?sku=${sku}&action=getProductTitle`, { method: "GET" });
          console.log(`Fetching title for SKU ${sku}: Status ${response.status}`);
          if (response.ok) {
            const data = await response.json();
            if (data.title) {
              productTitle.innerHTML = `
                <p><strong>Product:</strong> ${data.title}</p>
                ${data.price ? `<p><strong>Price:</strong> ${data.price}</p>` : ''}
                ${data.description ? `<p><strong>Description:</strong> ${data.description}</p>` : ''}
                ${data.categories ? `<p><strong>Categories:</strong> ${data.categories}</p>` : ''}
              `;
              productTitle.style.display = "block";
            } else {
              console.log(`No title returned for SKU ${sku}`);
            }
          } else {
            console.log(`Failed to fetch title for SKU ${sku}: Status ${response.status}`);
          }
        } catch (error) {
          console.error(`Error fetching title for SKU ${sku}: ${error.message}`);
        }
        
        const imgContainer = document.createElement("div");
        imgContainer.classList.add("img-container");
        tableContainer.appendChild(imgContainer);
        
        for (const size of displaySizes) {
          for (const type of section.fileTypes) {
            const innerCard = document.createElement("div");
            innerCard.classList.add("inner-card");
            imgContainer.appendChild(innerCard);
            
            const heading = `${size}${type}`;
            innerCard.innerHTML += `<h3>${heading}</h3>`;
            
            const imgSrc = `/api/fetch-image?sku=${sku}&size=${size}&type=${type}`;
            const img = document.createElement("img");
            img.src = imgSrc;
            img.alt = `${heading} for SKU ${sku}`;
            img.classList.add("default-image");
            
            img.onerror = async () => {
              failedImages++;
              missingImages.push(heading);
              innerCard.removeChild(img);
              const errorText = document.createElement("div");
              errorText.classList.add("image-error");
              errorText.textContent = `Image not found for ${heading}`;
              innerCard.appendChild(errorText);
              
              console.log(`Failed to load ${imgSrc}`);
              if (loadedImages + failedImages === totalImages) {
                loading.style.display = "none";
                if (loadedImages === 0) {
                  try {
                    const response = await fetch(imgSrc);
                    const data = response.ok ? await response.json() : { error: `Status ${response.status}` };
                    errorMessage.textContent = `Error: No images found for SKU ${sku}. ${data.error || 'The SKU may not exist or the server is unavailable.'}`;
                    errorMessage.style.display = "block";
                  } catch (error) {
                    errorMessage.textContent = `Error: No images found for SKU ${sku}. Failed to connect to server: ${error.message}`;
                    errorMessage.style.display = "block";
                  }
                } else if (loadedImages > 0 && !validSKUs.includes(sku)) {
                  validSKUs.push(sku);
                  updateInteriorButtonState();
                  updateValidSKUsRange();
                }
                if (missingImages.length > 0) {
                  errorMessage.textContent = `Warning: Some images missing for SKU ${sku}: ${missingImages.join(", ")}`;
                  errorMessage.style.display = "block";
                }
              }
            };
            
            img.onload = () => {
              loadedImages++;
              console.log(`Loaded ${imgSrc}`);
              if (loadedImages + failedImages === totalImages) {
                loading.style.display = "none";
                if (loadedImages > 0 && !validSKUs.includes(sku)) {
                  validSKUs.push(sku);
                  updateInteriorButtonState();
                  updateValidSKUsRange();
                }
                if (missingImages.length > 0) {
                  errorMessage.textContent = `Warning: Some images missing for SKU ${sku}: ${missingImages.join(", ")}`;
                  errorMessage.style.display = "block";
                }
              }
            };
            
            innerCard.appendChild(img);
          }
        }
      }
      
      function updateCheckedSKUsDisplay() {
        if (testedSKUs.length === 0) {
          checkedSKUsDisplay.textContent = "Checked SKUs (no images): None";
        } else {
          checkedSKUsDisplay.textContent = `Checked SKUs (no images): ${testedSKUs.join(", ")}`;
        }
      }
      
      function updateValidSKUsRange() {
        if (validSKUs.length === 0) {
          validSKUsRangeDisplay.textContent = "Known SKUs with images: None";
        } else {
          const sortedSKUs = validSKUs.sort((a, b) => skuToNumber(a) - skuToNumber(b));
          validSKUsRangeDisplay.textContent = `Known SKUs with images: Min: ${sortedSKUs[0]}, Max: ${sortedSKUs[sortedSKUs.length - 1]}`;
        }
      }
      
      function updateInteriorButtonState() {
        prevInteriorBtn.disabled = validSKUs.length === 0;
        nextInteriorBtn.disabled = validSKUs.length === 0;
      }
      
      function clearForm() {
        skuInput.value = "00000";
        currentSKU = "00000";
        localStorage.setItem("currentSKU", currentSKU);
        errorMessage.style.display = "none";
        errorMessage.textContent = "";
        productTitle.style.display = "none";
        productTitle.innerHTML = "";
        loading.style.display = "none";
        cancelBtn.style.display = "none";
        batchDownloadBtn.style.display = "none";
        tableContainer.innerHTML = "";
        testedSKUs = [];
        validSKUs = [];
        batchSKUs = [];
        isScanning = false;
        showAllSizes = false;
        sizesBtn.textContent = "Sizes";
        sizesBtn.setAttribute("aria-expanded", "false");
        sizesBtn.setAttribute("aria-label", "Show additional image sizes");
        downloadBtn.style.display = "none";
        batchSaveBtn.style.display = "none";
        searchBtn.style.display = "none";
        batchModal.style.display = "none";
        batchModalOverlay.style.display = "none";
        batchSKUInput.value = "";
        batchError.style.display = "none";
        if (abortController) {
          abortController.abort();
          abortController = null;
        }
        updateCheckedSKUsDisplay();
        updateValidSKUsRange();
        updateInteriorButtonState();
      }
      
      function cancelScan() {
        if (!isScanning || !abortController) return;
        abortController.abort();
        abortController = null;
        isScanning = false;
        cancelBtn.style.display = "none";
        batchDownloadBtn.style.display = batchSKUs.length > 0 ? "inline-block" : "none";
        loading.style.display = "none";
        errorMessage.style.display = "none";
        errorMessage.textContent = "";
        productTitle.style.display = "none";
        productTitle.innerHTML = "";
        currentSKU = lastSKU;
        skuInput.value = currentSKU;
        localStorage.setItem("currentSKU", currentSKU);
        console.log(`Scan cancelled, reverting to SKU ${currentSKU}`);
        displayImages(currentSKU);
      }
    </script>
  </body>
</html>
