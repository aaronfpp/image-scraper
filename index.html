<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>ImageScraper by Tate</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="icon" href="/icons/favicon.ico" type="image/x-icon" sizes="16x16 32x32">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png">
  <link rel="manifest" href="/icons/site.webmanifest">
    <style>
      html, body {
        font-family: system-ui;
        margin: 0;
        padding: 0;
        text-align: center;
        background-color: #e8e8e8;
        color: #000000;
        min-height: 100vh;
      }
      
      body {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }
      
      main {
        flex: 1 0 auto;
      }
      
      footer {
        flex-shrink: 0;
        font-size: 12pt;
        text-align: center;
        padding: 10px;
        color: #000000;
      }
      
      .dark-theme footer {
        color: #ffffff;
      }
      
      h1 {
        margin-top: 0;
      }
      
      .dark-theme {
        background: url('https://auth.ifsta.org/images/background_e8.jpg') no-repeat center center fixed;
        background-size: cover;
        color: #ffffff;
      }
      
      #formID {
        font-size: 16pt;
        margin: 20px 0;
      }
      
      .img-container {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
      }
      
      .inner-card {
        display: inline-block;
        text-align: center;
        background-color: #abebff;
        margin: 10px;
        padding: 10px;
      }
      
      .dark-theme .inner-card {
        background-color: #cbccce;
      }
      
      .inner-card h3 {
        color: #000000;
      }
      
      #error-message {
        color: red;
        font-size: 14pt;
        margin-top: 10px;
        display: none;
      }
      
      .dark-theme #error-message {
        color: #ff9999;
      }
      
      .btn {
        font-size: 14pt;
        margin: 0 5px;
        padding: 5px 15px;
        cursor: pointer;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
      }
      
      .btn:hover {
        background-color: #0056b3;
      }
      
      .dark-theme .btn {
        background-color: #b32318;
      }
      
      .dark-theme .btn:hover {
        background-color: #8e1c13;
      }
      
      .btn:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
        color: #666666;
      }
      
      .dark-theme .btn:disabled {
        color: #999999;
      }
      
      #cancel-btn {
        background-color: #dc3545;
      }
      
      .dark-theme #cancel-btn {
        background-color: #b32318;
      }
      
      #cancel-btn:hover {
        background-color: #c82333;
      }
      
      .dark-theme #cancel-btn:hover {
        background-color: #8e1c13;
      }
      
      #theme-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        background-color: #17a2b8;
        font-size: 12pt;
        padding: 8px;
      }
      
      #theme-btn:hover {
        background-color: #138496;
      }
      
      .dark-theme #theme-btn {
        background-color: #b32318;
      }
      
      .dark-theme #theme-btn:hover {
        background-color: #8e1c13;
      }
      
      #download-btn {
        position: absolute;
        top: 10px;
        right: 50px;
        background-color: #17a2b8;
        font-size: 12pt;
        padding: 8px;
        display: none;
      }
      
      #download-btn:hover {
        background-color: #138496;
      }
      
      .dark-theme #download-btn {
        background-color: #b32318;
      }
      
      .dark-theme #download-btn:hover {
        background-color: #8e1c13;
      }
      
      #search-btn {
        position: absolute;
        top: 10px;
        right: 90px;
        background-color: #17a2b8;
        font-size: 12pt;
        padding: 8px;
        display: none;
      }
      
      #search-btn:hover {
        background-color: #138496;
      }
      
      .dark-theme #search-btn {
        background-color: #b32318;
      }
      
      .dark-theme #search-btn:hover {
        background-color: #8e1c13;
      }
      
      img {
        max-width: 100%;
        height: auto;
        display: block;
      }
      
      .default-image {
        max-width: 400px;
      }
      
      .image-error {
        color: red;
        font-size: 12pt;
        margin: 10px 0;
      }
      
      .dark-theme .image-error {
        color: #ff9999;
      }
      
      #loading {
        font-size: 14pt;
        margin-top: 10px;
        display: none;
      }
      
      .dark-theme #loading {
        color: #ffffff;
      }
      
      #sku-input {
        font-size: 16pt;
        margin: 0 5px;
        padding: 5px;
        width: 100px;
        text-align: center;
        color: #000000;
      }
      
      .dark-theme #sku-input {
        color: #ffffff;
        background-color: #333333;
        border: 1px solid #ffffff;
      }
      
      #checked-skus, #valid-skus-range {
        font-size: 14pt;
        margin-top: 10px;
        max-width: 600px;
        margin-left: auto;
        margin-right: auto;
        word-wrap: break-word;
      }
      
      .dark-theme #checked-skus,
      .dark-theme #valid-skus-range {
        color: #ffffff;
      }
      
      .dark-theme h1,
      .dark-theme h2 {
        color: #ffffff;
      }
      
      #cancel-btn {
        display: none;
      }
    </style>
  </head>
  <body>
    <main>
      <button id="search-btn" class="btn" aria-label="Search IFSTA for SKU"><i class="fas fa-globe"></i></button>
      <button id="download-btn" class="btn" aria-label="Download PNG images as ZIP"><i class="fas fa-cloud-arrow-down"></i></button>
      <button id="theme-btn" class="btn" aria-label="Switch to dark theme"><i class="fas fa-paint-brush"></i></button>
      <h1>Welcome to ImageScraper!</h1>
      <h2>By Tate</h2>
      <div id="formID">
        <button id="sizes-btn" class="btn" aria-label="Show additional image sizes" aria-expanded="false">Sizes</button>
        <button id="prev-exterior-btn" class="btn" aria-label="Previous Untested Product">≪</button>
        <button id="prev-interior-btn" class="btn" aria-label="Previous Valid Product" disabled>←</button>
        <input type="text" id="sku-input" aria-required="true" value="00000">
        <button id="next-interior-btn" class="btn" aria-label="Next Valid Product" disabled>→</button>
        <button id="next-exterior-btn" class="btn" aria-label="Next Untested Product">≫</button>
        <button id="submit-btn" class="btn" aria-label="Submit SKU">Go</button>
        <button id="clear-btn" class="btn" aria-label="Clear input and images">Clear</button>
        <button id="cancel-btn" class="btn" aria-label="Cancel ongoing scan">Cancel</button>
      </div>
      <div id="error-message" aria-live="polite"></div>
      <div id="loading">Loading...</div>
      <div id="tableID"></div>
      <div id="checked-skus">Checked SKUs (no images): None</div>
      <div id="valid-skus-range">Known SKUs with images: None</div>
    </main>
    <footer id="footer" aria-label="IFSTA Copyright 2025">
    IFSTA © 2025 <a href="https://github.com/aaronfpp/image-scraper">https://github.com/aaronfpp/image-scraper</a>
    </footer>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script type="text/javascript">
      const section = {
        baseURL: "https://images.ifsta.org/products/",
        sizes: ["default", "thumb", "69", "100", "130", "150", "180", "200", "200x200", "420"],
        fileTypes: [".png", ".webp"],
        inputLabel: "SKU",
        validationRegex: /^[0-9]{5}$/,
        fetchTimeout: 10000
      };
      
      const themeBtn = document.getElementById("theme-btn");
      const downloadBtn = document.getElementById("download-btn");
      const searchBtn = document.getElementById("search-btn");
      const sizesBtn = document.getElementById("sizes-btn");
      const prevExteriorBtn = document.getElementById("prev-exterior-btn");
      const nextExteriorBtn = document.getElementById("next-exterior-btn");
      const prevInteriorBtn = document.getElementById("prev-interior-btn");
      const nextInteriorBtn = document.getElementById("next-interior-btn");
      const skuInput = document.getElementById("sku-input");
      const submitBtn = document.getElementById("submit-btn");
      const clearBtn = document.getElementById("clear-btn");
      const cancelBtn = document.getElementById("cancel-btn");
      const errorMessage = document.getElementById("error-message");
      const loading = document.getElementById("loading");
      const tableContainer = document.getElementById("tableID");
      const checkedSKUsDisplay = document.getElementById("checked-skus");
      const validSKUsRangeDisplay = document.getElementById("valid-skus-range");
      
      // Initialize SKU history from localStorage
      let testedSKUs = JSON.parse(localStorage.getItem("testedSKUs")) || [];
      let validSKUs = JSON.parse(localStorage.getItem("validSKUs")) || [];
      let currentSKU = localStorage.getItem("currentSKU") && section.validationRegex.test(localStorage.getItem("currentSKU")) ? localStorage.getItem("currentSKU") : "00000";
      let isScanning = false;
      let abortController = null;
      let lastSKU = currentSKU;
      let scanCount = 0;
      const maxScanAttempts = 100;
      let showAllSizes = false;
      let isDarkTheme = false;
      
      skuInput.value = currentSKU;
      updateCheckedSKUsDisplay();
      updateValidSKUsRange();
      updateInteriorButtonState();
      
      themeBtn.addEventListener("click", toggleTheme);
      downloadBtn.addEventListener("click", downloadImagesAsZip);
      searchBtn.addEventListener("click", searchIFSTA);
      sizesBtn.addEventListener("click", toggleSizes);
      prevExteriorBtn.addEventListener("click", () => navigateSKU(-1));
      nextExteriorBtn.addEventListener("click", () => navigateSKU(1));
      prevInteriorBtn.addEventListener("click", () => navigateValidSKU(-1));
      nextInteriorBtn.addEventListener("click", () => navigateValidSKU(1));
      submitBtn.addEventListener("click", submitSKU);
      skuInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") submitSKU();
      });
      clearBtn.addEventListener("click", clearForm);
      cancelBtn.addEventListener("click", cancelScan);
      
      displayImages(currentSKU);
      
      function toggleTheme() {
        isDarkTheme = !isDarkTheme;
        document.body.classList.toggle("dark-theme");
        themeBtn.setAttribute("aria-label", isDarkTheme ? "Switch to light theme" : "Switch to dark theme");
      }
      
      function toggleSizes() {
        showAllSizes = !showAllSizes;
        sizesBtn.textContent = showAllSizes ? "Hide Sizes" : "Sizes";
        sizesBtn.setAttribute("aria-expanded", showAllSizes);
        sizesBtn.setAttribute("aria-label", showAllSizes ? "Hide additional image sizes" : "Show additional image sizes");
        downloadBtn.style.display = showAllSizes ? "inline-block" : "none";
        searchBtn.style.display = showAllSizes ? "inline-block" : "none";
        displayImages(currentSKU);
      }
      
      function searchIFSTA() {
        const searchUrl = `https://www.ifsta.org/shop/search?search_block_form=${currentSKU}`;
        window.open(searchUrl, '_blank');
      }
      
      async function downloadImagesAsZip() {
        downloadBtn.disabled = true;
        errorMessage.style.display = "none";
        errorMessage.textContent = "";
        loading.style.display = "block";
        
        const zip = new JSZip();
        let hasImages = false;
        const missingImages = [];
        
        for (const size of section.sizes) {
          const type = ".png"; // Only download PNG files
          const url = `/api/fetch-image?sku=${currentSKU}&size=${size}&type=${type}`;
          const fileName = `${currentSKU}_${size}${type}`;
          
          try {
            const response = await fetch(url, { method: "GET" });
            console.log(`Fetching ${url}: Status ${response.status}`);
            if (response.ok) {
              const data = await response.json();
              if (data.isBase64Encoded) {
                const binaryString = atob(data.body);
                const len = binaryString.length;
                const bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++) {
                  bytes[i] = binaryString.charCodeAt(i);
                }
                const blob = new Blob([bytes], { type: data.contentType });
                zip.file(fileName, blob);
                hasImages = true;
              } else {
                throw new Error('Response is not base64 encoded');
              }
            } else {
              missingImages.push(`${size}${type}`);
              console.log(`Failed to fetch ${url}: Status ${response.status}`);
            }
          } catch (error) {
            missingImages.push(`${size}${type}`);
            console.error(`Error fetching ${url}: ${error.message}`);
          }
        }
        
        if (!hasImages) {
          loading.style.display = "none";
          errorMessage.textContent = `Error: No PNG images found for SKU ${currentSKU}. Missing: ${missingImages.join(", ")}`;
          errorMessage.style.display = "block";
          downloadBtn.disabled = false;
          return;
        }
        
        try {
          const content = await zip.generateAsync({ type: "blob" });
          saveAs(content, `images_${currentSKU}.zip`);
          if (missingImages.length > 0) {
            errorMessage.textContent = `Warning: Some PNG images missing for SKU ${currentSKU}: ${missingImages.join(", ")}`;
            errorMessage.style.display = "block";
          }
        } catch (error) {
          console.error(`Error generating ZIP: ${error.message}`);
          errorMessage.textContent = "Error: Failed to generate ZIP file.";
          errorMessage.style.display = "block";
        }
        
        loading.style.display = "none";
        downloadBtn.disabled = false;
      }
      
      async function submitSKU() {
        const input = skuInput.value.trim();
        errorMessage.style.display = "none";
        errorMessage.textContent = "";
        loading.style.display = "block";
        tableContainer.innerHTML = "";
        testedSKUs = []; // Reset testedSKUs on manual submission
        localStorage.setItem("testedSKUs", JSON.stringify(testedSKUs));
        checkedSKUsDisplay.textContent = "Checked SKUs (no images): None";
        
        if (!input) {
          loading.style.display = "none";
          errorMessage.textContent = "Error: SKU cannot be empty.";
          errorMessage.style.display = "block";
          return;
        }
        
        if (!section.validationRegex.test(input)) {
          loading.style.display = "none";
          errorMessage.textContent = "Error: SKU must be a 5-digit number (e.g., 12345).";
          errorMessage.style.display = "block";
          return;
        }
        
        currentSKU = input;
        skuInput.value = currentSKU;
        localStorage.setItem("currentSKU", currentSKU);
        displayImages(currentSKU);
      }
      
      async function navigateSKU(direction) {
        if (isScanning) return;
        isScanning = true;
        lastSKU = currentSKU;
        abortController = new AbortController();
        cancelBtn.style.display = "inline-block";
        scanCount = 0;
        
        // Disable navigation buttons during scan
        prevExteriorBtn.disabled = true;
        nextExteriorBtn.disabled = true;
        
        errorMessage.style.display = "none";
        errorMessage.textContent = "";
        loading.style.display = "block";
        tableContainer.innerHTML = "";
        
        console.log(`Starting scan from SKU ${currentSKU}, direction ${direction}, testedSKUs: ${testedSKUs.join(", ")}`);
        
        try {
          await navigateSKUInternal(direction);
        } catch (error) {
          console.error(`Scan error: ${error.message}`);
          isScanning = false;
          cancelBtn.style.display = "none";
          prevExteriorBtn.disabled = false;
          nextExteriorBtn.disabled = false;
          testedSKUs = [];
          localStorage.setItem("testedSKUs", JSON.stringify(testedSKUs));
          checkedSKUsDisplay.textContent = "Checked SKUs (no images): None";
          loading.style.display = "none";
          errorMessage.textContent = `Error during scan: ${error.message}`;
          errorMessage.style.display = "block";
        }
      }
      
      async function navigateSKUInternal(direction) {
        if (scanCount >= maxScanAttempts) {
          isScanning = false;
          cancelBtn.style.display = "none";
          prevExteriorBtn.disabled = false;
          nextExteriorBtn.disabled = false;
          loading.style.display = "none";
          errorMessage.textContent = "Error: No valid SKUs found after checking multiple options. Try a different range or manual entry.";
          errorMessage.style.display = "block";
          console.log(`Scan stopped: Reached maxScanAttempts (${maxScanAttempts})`);
          return;
        }
        
        let nextSKU = getNextSKU(currentSKU, direction);
        while (nextSKU !== null && testedSKUs.includes(nextSKU) && !abortController.signal.aborted) {
          console.log(`Skipping SKU ${nextSKU}: Already in testedSKUs`);
          nextSKU = getNextSKU(nextSKU, direction);
        }
        
        if (nextSKU === null || abortController.signal.aborted) {
          isScanning = false;
          cancelBtn.style.display = "none";
          prevExteriorBtn.disabled = false;
          nextExteriorBtn.disabled = false;
          loading.style.display = "none";
          if (nextSKU === null) {
            errorMessage.textContent = `Error: Reached ${direction > 0 ? "maximum" : "minimum"} SKU.`;
            errorMessage.style.display = "block";
            console.log(`Scan stopped: Reached ${direction > 0 ? "maximum" : "minimum"} SKU`);
          } else {
            console.log(`Scan stopped: Aborted`);
          }
          return;
        }
        
        scanCount++;
        console.log(`Checking SKU ${nextSKU}, scanCount: ${scanCount}`);
        const hasImages = await checkImages(nextSKU, abortController.signal);
        if (abortController.signal.aborted) {
          isScanning = false;
          cancelBtn.style.display = "none";
          prevExteriorBtn.disabled = false;
          nextExteriorBtn.disabled = false;
          loading.style.display = "none";
          console.log(`Scan aborted for SKU ${nextSKU}`);
          return;
        }
        
        if (hasImages) {
          currentSKU = nextSKU;
          skuInput.value = currentSKU;
          localStorage.setItem("currentSKU", currentSKU);
          if (!validSKUs.includes(nextSKU)) {
            validSKUs.push(nextSKU);
            localStorage.setItem("validSKUs", JSON.stringify(validSKUs));
            updateInteriorButtonState();
            updateValidSKUsRange();
          }
          console.log(`Found valid SKU ${nextSKU}, displaying images`);
          displayImages(currentSKU);
          // Reset scan state
          isScanning = false;
          cancelBtn.style.display = "none";
          prevExteriorBtn.disabled = false;
          nextExteriorBtn.disabled = false;
          loading.style.display = "none";
          testedSKUs = [];
          localStorage.setItem("testedSKUs", JSON.stringify(testedSKUs));
          checkedSKUsDisplay.textContent = "Checked SKUs (no images): None";
        } else {
          console.log(`No images for SKU ${nextSKU}, adding to testedSKUs`);
          testedSKUs.push(nextSKU);
          localStorage.setItem("testedSKUs", JSON.stringify(testedSKUs));
          updateCheckedSKUsDisplay();
          await navigateSKUInternal(direction);
        }
      }
      
      function navigateValidSKU(direction) {
        if (validSKUs.length === 0) {
          errorMessage.style.display = "none";
          errorMessage.textContent = "Error: No valid SKUs with images found yet. Use exterior arrows to find some.";
          errorMessage.style.display = "block";
          loading.style.display = "none";
          console.log(`No valid SKUs for interior navigation`);
          return;
        }
        
        errorMessage.style.display = "none";
        errorMessage.textContent = "";
        loading.style.display = "block";
        tableContainer.innerHTML = "";
        
        const currentValue = skuToNumber(currentSKU);
        const candidates = validSKUs
          .map(sku => ({ sku, value: skuToNumber(sku) }))
          .filter(item => direction > 0 ? item.value > currentValue : item.value < currentValue)
          .sort((a, b) => direction > 0 ? a.value - b.value : b.value - a.value);
        
        if (candidates.length === 0) {
          loading.style.display = "none";
          errorMessage.textContent = `No more known SKUs with images in this direction. Use exterior arrows to find more.`;
          errorMessage.style.display = "block";
          console.log(`No more valid SKUs in direction ${direction}`);
          return;
        }
        
        currentSKU = candidates[0].sku;
        skuInput.value = currentSKU;
        localStorage.setItem("currentSKU", currentSKU);
        console.log(`Navigating to valid SKU ${currentSKU}`);
        displayImages(currentSKU);
      }
      
      function skuToNumber(sku) {
        return parseInt(sku, 10);
      }
      
      function getNextSKU(sku, direction) {
        if (!section.validationRegex.test(sku)) {
          return "00000";
        }
        
        const num = parseInt(sku, 10);
        const nextNum = num + direction;
        
        if (nextNum < 0 || nextNum > 99999) {
          return null;
        }
        
        return nextNum.toString().padStart(5, "0");
      }
      
      async function checkImages(sku, signal) {
        const urls = [`/api/fetch-image?sku=${sku}&size=100&type=.png`];
        let hasImages = false;
        
        for (const url of urls) {
          let attempts = 0;
          const maxAttempts = 3;
          
          while (attempts < maxAttempts && !signal.aborted) {
            const timeoutController = new AbortController();
            const timeoutId = setTimeout(() => timeoutController.abort(), section.fetchTimeout);
            
            try {
              const response = await fetch(url, { 
                method: 'GET', 
                signal: AbortSignal.any([signal, timeoutController.signal])
              });
              console.log(`Checking ${url}: Status ${response.status}, Attempt ${attempts + 1}`);
              if (response.ok) {
                try {
                  const data = await response.json();
                  if (data.isBase64Encoded) {
                    hasImages = true;
                  } else {
                    console.log(`Invalid response for ${url}: Not base64 encoded`);
                    hasImages = true; // Assume valid if response is 200
                  }
                } catch (error) {
                  console.error(`Error parsing JSON for ${url}: ${error.message}`);
                  hasImages = true; // Assume valid if response is 200 but JSON fails
                }
              } else if ([429, 503].includes(response.status)) {
                console.log(`Retrying ${url}: Status ${response.status}`);
                attempts++;
                await new Promise(resolve => setTimeout(resolve, 1000));
                continue;
              } else {
                console.log(`Failed to fetch ${url}: Status ${response.status}`);
                break;
              }
            } catch (error) {
              console.error(`Error checking ${url}: ${error.message}, Attempt ${attempts + 1}`);
              if (error.name === "AbortError" && !signal.aborted) {
                console.log(`Timeout for ${url}, retrying...`);
                attempts++;
                await new Promise(resolve => setTimeout(resolve, 1000));
                continue;
              } else if (error.name === "AbortError") {
                clearTimeout(timeoutId);
                throw error; // Manual abort via cancel button
              }
              break; // Other errors (e.g., network failure)
            } finally {
              clearTimeout(timeoutId);
            }
            if (hasImages) break;
          }
          if (hasImages) break;
          await new Promise(resolve => setTimeout(resolve, 500));
        }
        
        console.log(`checkImages for SKU ${sku}: ${hasImages ? "Valid" : "Invalid"}`);
        if (!hasImages) {
          errorMessage.textContent = `Error: No images found for SKU ${sku}. The SKU may not exist or the server is unavailable.`;
          errorMessage.style.display = "block";
        }
        return hasImages;
      }
      
      async function displayImages(sku) {
        tableContainer.innerHTML = "";
        let loadedImages = 0;
        let failedImages = 0;
        const displaySizes = showAllSizes ? section.sizes : [section.sizes[0]];
        const totalImages = displaySizes.length * section.fileTypes.length;
        const missingImages = [];
        
        const imgContainer = document.createElement("div");
        imgContainer.classList.add("img-container");
        tableContainer.appendChild(imgContainer);
        
        for (const size of displaySizes) {
          for (const type of section.fileTypes) {
            const innerCard = document.createElement("div");
            innerCard.classList.add("inner-card");
            imgContainer.appendChild(innerCard);
            
            const heading = `${size}${type}`;
            innerCard.innerHTML += `<h3>${heading}</h3>`;
            
            const imgSrc = `/api/fetch-image?sku=${sku}&size=${size}&type=${type}`;
            const img = document.createElement("img");
            img.alt = `${heading} for SKU ${sku}`;
            img.classList.add("default-image");
            
            try {
              const response = await fetch(imgSrc, { method: 'GET' });
              console.log(`Fetching ${imgSrc}: Status ${response.status}`);
              if (response.ok) {
                const data = await response.json();
                if (data.isBase64Encoded) {
                  img.src = `data:${data.contentType};base64,${data.body}`;
                  innerCard.appendChild(img);
                } else {
                  throw new Error('Response is not base64 encoded');
                }
              } else {
                throw new Error(`Status ${response.status}`);
              }
            } catch (error) {
              failedImages++;
              missingImages.push(heading);
              const errorText = document.createElement("div");
              errorText.classList.add("image-error");
              errorText.textContent = `Image not found for ${heading}`;
              innerCard.appendChild(errorText);
              console.log(`Failed to load ${imgSrc}: ${error.message}`);
            }
            
            img.onload = () => {
              loadedImages++;
              console.log(`Loaded ${imgSrc}`);
              if (loadedImages + failedImages === totalImages) {
                loading.style.display = "none";
                if (loadedImages > 0 && !validSKUs.includes(sku)) {
                  validSKUs.push(sku);
                  localStorage.setItem("validSKUs", JSON.stringify(validSKUs));
                  updateInteriorButtonState();
                  updateValidSKUsRange();
                }
                if (loadedImages === 0) {
                  errorMessage.textContent = `Error: No images found for SKU ${sku}. The SKU may not exist or the server is unavailable.`;
                  errorMessage.style.display = "block";
                } else if (missingImages.length > 0) {
                  errorMessage.textContent = `Warning: Some images missing for SKU ${sku}: ${missingImages.join(", ")}`;
                  errorMessage.style.display = "block";
                }
              }
            };
            
            img.onerror = () => {
              failedImages++;
              missingImages.push(heading);
              innerCard.removeChild(img);
              const errorText = document.createElement("div");
              errorText.classList.add("image-error");
              errorText.textContent = `Image not found for ${heading}`;
              innerCard.appendChild(errorText);
              console.log(`Failed to load ${imgSrc}`);
              if (loadedImages + failedImages === totalImages) {
                loading.style.display = "none";
                if (loadedImages > 0 && !validSKUs.includes(sku)) {
                  validSKUs.push(sku);
                  localStorage.setItem("validSKUs", JSON.stringify(validSKUs));
                  updateInteriorButtonState();
                  updateValidSKUsRange();
                }
                if (loadedImages === 0) {
                  errorMessage.textContent = `Error: No images found for SKU ${sku}. The SKU may not exist or the server is unavailable.`;
                  errorMessage.style.display = "block";
                } else if (missingImages.length > 0) {
                  errorMessage.textContent = `Warning: Some images missing for SKU ${sku}: ${missingImages.join(", ")}`;
                  errorMessage.style.display = "block";
                }
              }
            };
            
            if (img.src) {
              innerCard.appendChild(img);
            }
          }
        }
      }
      
      function updateCheckedSKUsDisplay() {
        if (testedSKUs.length === 0) {
          checkedSKUsDisplay.textContent = "Checked SKUs (no images): None";
        } else {
          checkedSKUsDisplay.textContent = `Checked SKUs (no images): ${testedSKUs.join(", ")}`;
        }
      }
      
      function updateValidSKUsRange() {
        if (validSKUs.length === 0) {
          validSKUsRangeDisplay.textContent = "Known SKUs with images: None";
        } else {
          const sortedSKUs = validSKUs.sort((a, b) => skuToNumber(a) - skuToNumber(b));
          validSKUsRangeDisplay.textContent = `Known SKUs with images: Min: ${sortedSKUs[0]}, Max: ${sortedSKUs[sortedSKUs.length - 1]}`;
        }
      }
      
      function updateInteriorButtonState() {
        prevInteriorBtn.disabled = validSKUs.length === 0;
        nextInteriorBtn.disabled = validSKUs.length === 0;
      }
      
      function clearForm() {
        skuInput.value = "00000";
        currentSKU = "00000";
        localStorage.setItem("currentSKU", currentSKU);
        errorMessage.style.display = "none";
        errorMessage.textContent = "";
        loading.style.display = "none";
        cancelBtn.style.display = "none";
        tableContainer.innerHTML = "";
        testedSKUs = [];
        validSKUs = [];
        localStorage.setItem("testedSKUs", JSON.stringify(testedSKUs));
        localStorage.setItem("validSKUs", JSON.stringify(validSKUs));
        isScanning = false;
        showAllSizes = false;
        sizesBtn.textContent = "Sizes";
        sizesBtn.setAttribute("aria-expanded", "false");
        sizesBtn.setAttribute("aria-label", "Show additional image sizes");
        downloadBtn.style.display = "none";
        searchBtn.style.display = "none";
        if (abortController) {
          abortController.abort();
          abortController = null;
        }
        updateCheckedSKUsDisplay();
        updateValidSKUsRange();
        updateInteriorButtonState();
      }
      
      function cancelScan() {
        if (!isScanning || !abortController) return;
        abortController.abort();
        abortController = null;
        isScanning = false;
        cancelBtn.style.display = "none";
        prevExteriorBtn.disabled = false;
        nextExteriorBtn.disabled = false;
        loading.style.display = "none";
        errorMessage.style.display = "none";
        errorMessage.textContent = "";
        currentSKU = lastSKU;
        skuInput.value = currentSKU;
        localStorage.setItem("currentSKU", currentSKU);
        console.log(`Scan cancelled, reverting to SKU ${currentSKU}`);
        displayImages(currentSKU);
      }
    </script>
  </body>
</html>
